<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dietapp</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --background: #f5f6fa;
            --surface: #ffffff;
            --text: #2c3e50;
            --border: #ecf0f1;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --meal-gap: 15px;
        }

        [data-theme="dark"] {
            --primary: #3498db;
            --secondary: #2c3e50;
            --background: #2c3e50;
            --surface: #34495e;
            --text: #ecf0f1;
            --border: #2c3e50;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--background);
            color: var(--text);
            transition: background 0.3s, color 0.3s;
        }

        /* Estilos para las cantidades */
        .quantity-input {
            width: 60px !important;
            padding: 4px 6px !important;
            text-align: center;
            margin-right: 5px;
        }

        /* Contenedor de acciones de alimentos */
        .food-actions {
            display: flex;
            align-items: center;
            gap: 5px;
            min-width: 150px;
            justify-content: flex-end;
        }

        /* Estilos para los badges de macros */
        .macro-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin: 2px;
        }

        .macro-badge.calories { background: rgba(255, 107, 107, 0.2); }
        .macro-badge.protein { background: rgba(77, 171, 247, 0.2); }
        .macro-badge.carbs { background: rgba(254, 202, 87, 0.2); }
        .macro-badge.fats { background: rgba(120, 224, 143, 0.2); }
        .macro-badge.cost { 
            background: rgba(159, 90, 253, 0.2);
            height: 100%;
            display: flex;
            align-items: center;
        }

        /* Contenedor de macros */
        .food-macros-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            margin-top: 5px;
        }

        /* Estilo para los √≠tems de comida */
        .food-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.05);
            border-radius: 5px;
            margin: 5px 0;
        }

        .food-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .food-name {
            flex: 1;
            min-width: 150px;
        }

        /* Ajustes para los botones de eliminar */
        .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--danger);
            font-size: 1.1em;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }


        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            /* A√±ade esto para el scroll personalizado */
            height: 100vh;
            overflow: hidden;
        }

        /* Columna izquierda (contenido principal) */
        .container > div:first-child {
            overflow-y: auto;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
            padding-right: 15px;
        }

        .container > div:first-child::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        @media (min-width: 768px) {
            .container {
                grid-template-columns: 2fr 1fr;
                height: calc(100vh - 40px); /* Ajusta seg√∫n tu header */
            }
        }

        h1, h2, h3 {
            color: var(--primary);
        }

        .diet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .meal-grid {
            display: flex;
            flex-direction: column;
            gap: var(--meal-gap);
        }

        .meal-card {
            background: var(--surface);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .meal-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .meal-macros {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
        }

        .macro-pill {
            background: rgba(0,0,0,0.1);
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.9em;
        }

        .add-meal-btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .food-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: rgba(0,0,0,0.05);
            border-radius: 5px;
            margin: 5px 0;
        }

        .food-actions {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .quantity-actions {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .quick-amount {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .quick-amount-btn {
            padding: 5px 10px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
            flex: 1;
        }

        .quick-amount-btn.add {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .quick-amount-btn.remove {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .quick-amount-btn:hover {
            transform: translateY(-2px);
            opacity: 0.7;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .food-macros-actions {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
        }

        .macros-cost-container {
            display: flex;
            gap: 5px;
        }

        .quick-amount-vertical {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-left: 5px;
        }

        .macros-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            flex: 1;
        }

        .cost-badge {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(159, 90, 253, 0.2);
            border-radius: 12px;
            margin-left: 5px;
            padding: 0 10px;
            min-width: 70px;
        }

        .cost-badge span {
            font-size: 0.7em;
            opacity: 0.8;
        }

        .nutrition-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            background: var(--secondary);
            color: white;
            margin: 2px;
            font-size: 0.9em;
        }

        .diet-variants {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .diet-variant {
            min-width: 200px;
            background: var(--surface);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .food-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: transparent;
            padding: 0;
            display: flex;
            gap: 20px;
            width: 90%;
            max-width: 900px; /* Aument√© el ancho m√°ximo para mejor visualizaci√≥n */
            max-height: 80vh;
            overflow-y: auto;
            border: none;
            box-shadow: none;
        }

        /* .modal-columns-container {
            display: flex;
            gap: 20px;
            height: 70vh;
        } */

        .modal-column {
            background: var(--surface);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex: 1;
            overflow: auto;
        }

        .selection-column {
            flex: 3;
            border: 1px solid var(--secondary);
        }

        .selected-column {
            flex: 2;
            border: 2px solid var(--primary);
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        .category-card {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
            background: rgba(0,0,0,0.05);
        }

        .category-card:hover {
            transform: translateY(-3px);
            background: rgba(0,0,0,0.1);
        }

        .food-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }

        .food-item-modal {
            padding: 15px;
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
            background: var(--surface);
            text-align: center;
        }

        .food-item-modal:hover {
            transform: translateY(-3px);
            background: rgba(0,0,0,0.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .food-item-modal.selected {
            border-color: var(--success);
            background: rgba(76, 175, 80, 0.1);
        }

        .food-item-modal.selected:hover {
            transform: translateY(-3px);
            background: rgba(76, 175, 80, 0.15);
        }

        .modal-selected-item {
            padding: 12px;
            margin: 10px 0;
            background: var(--surface);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .food-macros {
            font-size: 0.9em;
            color: var(--text);
            margin-top: 8px;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--surface);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.2em;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 100;
        }

        .diet-navigation {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .nav-btn {
            padding: 5px 10px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn {
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-primary {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        input[type="text"], input[type="number"] {
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 5px;
            background: var(--surface);
            color: var(--text);
            width: 100%;
        }

        .selected {
            background: rgba(52, 152, 219, 0.2);
        }

        .diets-list {
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
            border: 1px solid var(--border);
            border-radius: 5px;
            padding: 5px;
        }

        .diet-list-item {
            padding: 8px;
            cursor: pointer;
            border-radius: 3px;
        }

        .diet-list-item:hover {
            background: rgba(0,0,0,0.05);
        }

        .totals-section {
            position: sticky;
            top: 0;
            height: calc(100vh - 40px); /* Ajusta seg√∫n tu header */
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding-right: 15px;
        }

        .totals-section::-webkit-scrollbar {
            display: none;
        }

        .shopping-list {
            margin-top: 30px;
            background: var(--surface);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .shopping-list h3 {
            margin-top: 0;
        }

        .shopping-list-item {
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            margin: 4px 0;
        }

        .shopping-list-item:hover {
            background-color: rgba(0,0,0,0.05);
        }

        .shopping-list-tabs {
            display: flex;
            margin-bottom: 10px;
        }

        .shopping-list-tab {
            padding: 8px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .shopping-list-tab.active {
            border-bottom-color: var(--secondary);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="App.toggleTheme()">üåì</button>
    
    <h1 style="text-align: center;">üçé Dietapp</h1>
    
    <div class="container">
        <div>
            <div class="diet-header">
                <h2 id="current-diet-title">Dieta Actual</h2>
                <button class="btn btn-primary" onclick="App.exportPDF()">üìÑ Exportar PDF</button>
            </div>
            
            <div class="meal-grid" id="meals">
                <!-- Las comidas se generar√°n din√°micamente -->
            </div>
        </div>

        <div>
            <div class="totals-section">
                <h2>üíæ Dietas Guardadas</h2>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div class="diet-navigation">
                        <button class="nav-btn" onclick="App.prevDiet()">‚Üê</button>
                        <button class="nav-btn" onclick="App.nextDiet()">‚Üí</button>
                    </div>
                    <button class="btn btn-danger" onclick="App.deleteCurrentDiet()">üóë Eliminar</button>
                </div>
                
                <div style="margin-top: 20px;">
                    <input type="text" id="diet-name" placeholder="Nombre de la dieta">
                    <button class="btn btn-success" onclick="App.saveDiet()" style="margin-top: 10px; width: 100%;">
                        üíæ Guardar Dieta
                    </button>
                </div>

                <h2 style="margin-top: 30px;">üìä Totales Diarios</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
                    <div class="nutrition-badge">üî• Calor√≠as: <span id="total-cal">0</span></div>
                    <div class="nutrition-badge">üí™ Prote√≠na: <span id="total-pro">0</span>g</div>
                    <div class="nutrition-badge">üçû Carbos: <span id="total-carbs">0</span>g</div>
                    <div class="nutrition-badge">ü•ë Grasas: <span id="total-fat">0</span>g</div>
                    <div class="nutrition-badge">üíµ Costo: $<span id="total-cost">0</span></div>
                </div>

                <div class="shopping-list">
                    <h3>üõí Lista de Compra</h3>
                    <div class="shopping-list-tabs">
                        <div class="shopping-list-tab active" onclick="App.showShoppingList('weekly')">Semanal</div>
                        <div class="shopping-list-tab" onclick="App.showShoppingList('monthly')">Mensual</div>
                    </div>
                    <div class="shopping-list-content" id="shopping-list-content">
                        <!-- Contenido generado din√°micamente -->
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal de alimentos -->
    <div class="food-modal" id="foodModal">
        <div class="modal-content" id="modalContent"></div>
    </div>

    <script>
        const App = (() => {
            // Base de datos de alimentos
            const foodDB = {
                // Prote√≠nas animales
                'Pollo': { 
                    category: 'Prote√≠nas', 
                    emoji: 'üçó', 
                    price: 0.70, 
                    calories: 239, 
                    protein: 27, 
                    carbs: 0, 
                    fats: 14 
                },
                'Pechuga de pollo': { 
                    category: 'Prote√≠nas', 
                    emoji: 'üçó', 
                    price: 0.75, 
                    calories: 165, 
                    protein: 31, 
                    carbs: 0, 
                    fats: 3.6 
                },
                'Huevo': { 
                    category: 'Prote√≠nas', 
                    emoji: 'ü•ö', 
                    price: 0.25, 
                    calories: 155, 
                    protein: 13, 
                    carbs: 1.1, 
                    fats: 11 
                },
                'Claras': { 
                    category: 'Prote√≠nas', 
                    emoji: 'ü•ö', 
                    price: 0.40, 
                    calories: 52, 
                    protein: 11, 
                    carbs: 0.7, 
                    fats: 0.2 
                },
                'Salm√≥n': { 
                    category: 'Prote√≠nas', 
                    emoji: 'üêü', 
                    price: 2.10, 
                    calories: 208, 
                    protein: 20, 
                    carbs: 0, 
                    fats: 13 
                },
                'At√∫n en agua': { 
                    category: 'Prote√≠nas', 
                    emoji: 'üêü', 
                    price: 0.90, 
                    calories: 116, 
                    protein: 25.5, 
                    carbs: 0, 
                    fats: 0.8 
                },
                'At√∫n': { 
                    category: 'Prote√≠nas', 
                    emoji: 'üêü', 
                    price: 1.20, 
                    calories: 144, 
                    protein: 23, 
                    carbs: 0, 
                    fats: 5 
                },
                'Salm√≥n ahumado': { 
                    category: 'Prote√≠nas', 
                    emoji: 'üêü', 
                    price: 2.50, 
                    calories: 117, 
                    protein: 18, 
                    carbs: 0, 
                    fats: 4.3 
                },
                'Pavo': { 
                    category: 'Prote√≠nas', 
                    emoji: 'ü¶É', 
                    price: 1.40, 
                    calories: 135, 
                    protein: 29, 
                    carbs: 0, 
                    fats: 1.7 
                },
                'Pechuga de pavo': { 
                    category: 'Prote√≠nas', 
                    emoji: 'ü¶É', 
                    price: 1.50, 
                    calories: 135, 
                    protein: 29, 
                    carbs: 0, 
                    fats: 1.7 
                },
                'Jam√≥n de pavo': { 
                    category: 'Prote√≠nas', 
                    emoji: 'üçñ', 
                    price: 1.60, 
                    calories: 125, 
                    protein: 18, 
                    carbs: 2, 
                    fats: 5 
                },
                'Merluza': { 
                    category: 'Prote√≠nas', 
                    emoji: 'üêü', 
                    price: 1.80, 
                    calories: 91, 
                    protein: 19, 
                    carbs: 0, 
                    fats: 1.5 
                },
                'Caballa': { 
                    category: 'Prote√≠nas', 
                    emoji: 'üêü', 
                    price: 1.50, 
                    calories: 205, 
                    protein: 19, 
                    carbs: 0, 
                    fats: 14 
                },
                'Sardinas en lata': { 
                    category: 'Prote√≠nas', 
                    emoji: 'üêü', 
                    price: 0.90, 
                    calories: 208, 
                    protein: 25, 
                    carbs: 0, 
                    fats: 11 
                },
                'Palitos de merluza': { 
                    category: 'Prote√≠nas', 
                    emoji: 'üêü', 
                    price: 1.30, 
                    calories: 120, 
                    protein: 12, 
                    carbs: 10, 
                    fats: 4 
                },
                'Nuggets': { 
                    category: 'Prote√≠nas', 
                    emoji: 'üçó', 
                    price: 1.20, 
                    calories: 250, 
                    protein: 14, 
                    carbs: 15, 
                    fats: 15 
                },
                'Tortilla': { 
                    category: 'Prote√≠nas', 
                    emoji: 'üç≥', 
                    price: 0.80, 
                    calories: 154, 
                    protein: 13, 
                    carbs: 1.1, 
                    fats: 11 },
                
                // Prote√≠nas vegetales
                'Tofu': { 
                    category: 'Prote√≠nas', 
                    emoji: 'üßà', 
                    price: 1.50, 
                    calories: 76, 
                    protein: 8, 
                    carbs: 1.9, 
                    fats: 4.8 
                },
                'Prote√≠na en polvo': { 
                    category: 'Prote√≠nas', 
                    emoji: 'ü•Ñ', 
                    price: 3.00, 
                    calories: 120, 
                    protein: 24, 
                    carbs: 3, 
                    fats: 1 
                },
                'Prote√≠na de suero de leche': { 
                    category: 'Prote√≠nas', 
                    emoji: 'ü•Ñ', 
                    price: 3.20, 
                    calories: 120, 
                    protein: 24, 
                    carbs: 3, 
                    fats: 1 
                },
                'Batido de prote√≠nas': { 
                    category: 'Prote√≠nas', 
                    emoji: 'ü•§', 
                    price: 1.80, 
                    calories: 120, 
                    protein: 24, 
                    carbs: 3, 
                    fats: 1 
                },
                
                // L√°cteos
                'Yogur griego': { 
                    category: 'L√°cteos', 
                    emoji: 'ü•õ', 
                    price: 0.45, 
                    calories: 59, 
                    protein: 10, 
                    carbs: 3.6, 
                    fats: 0.4 
                },
                'Yogur griego natural': { 
                    category: 'L√°cteos', 
                    emoji: 'ü•õ', 
                    price: 0.45, 
                    calories: 59, 
                    protein: 10, 
                    carbs: 3.6, 
                    fats: 0.4 
                },
                'Yogur natural sin az√∫car': { 
                    category: 'L√°cteos', 
                    emoji: 'ü•õ', 
                    price: 0.35, 
                    calories: 59, 
                    protein: 3.5, 
                    carbs: 4.7, 
                    fats: 3.3 
                },
                'Yogur': { 
                    category: 'L√°cteos', 
                    emoji: 'ü•õ', 
                    price: 0.35, 
                    calories: 59, 
                    protein: 3.5, 
                    carbs: 4.7, 
                    fats: 3.3 
                },
                'Leche semidesnatada': { 
                    category: 'L√°cteos', 
                    emoji: 'ü•õ', 
                    price: 0.12, 
                    calories: 47, 
                    protein: 3.4, 
                    carbs: 4.8, 
                    fats: 1.6 
                },
                'Leche entera': { 
                    category: 'L√°cteos', 
                    emoji: 'ü•õ', 
                    price: 0.13, 
                    calories: 61, 
                    protein: 3.2, 
                    carbs: 4.8, 
                    fats: 3.3 
                },
                'Leche desnatada': { 
                    category: 'L√°cteos', 
                    emoji: 'ü•õ', 
                    price: 0.12, 
                    calories: 34, 
                    protein: 3.4, 
                    carbs: 4.8, 
                    fats: 0.1 
                },
                'Leche de avellana': { 
                    category: 'L√°cteos', 
                    emoji: 'ü•õ', 
                    price: 0.90, 
                    calories: 29, 
                    protein: 0.4, 
                    carbs: 1.8, 
                    fats: 2.7 
                },
                'Queso burgos desnatado': { 
                    category: 'L√°cteos', 
                    emoji: 'üßÄ', 
                    price: 1.20, 
                    calories: 72, 
                    protein: 12, 
                    carbs: 2, 
                    fats: 1 
                },
                'Queso tierno light': { 
                    category: 'L√°cteos', 
                    emoji: 'üßÄ', 
                    price: 1.50, 
                    calories: 190, 
                    protein: 24, 
                    carbs: 2, 
                    fats: 9 
                },
                
                // Cereales y derivados
                'Avena': { 
                    category: 'Cereales', 
                    emoji: 'üåæ', 
                    price: 0.15, 
                    calories: 389, 
                    protein: 16.9, 
                    carbs: 66.3, 
                    fats: 6.9 
                },
                'Copos de avena': { 
                    category: 'Cereales', 
                    emoji: 'üåæ', 
                    price: 0.15, 
                    calories: 389, 
                    protein: 16.9, 
                    carbs: 66.3, 
                    fats: 6.9 
                },
                'Aros de avena': { 
                    category: 'Cereales', 
                    emoji: 'üç©', 
                    price: 0.25, 
                    calories: 375, 
                    protein: 11, 
                    carbs: 69, 
                    fats: 7 
                },
                'Arroz': { 
                    category: 'Cereales', 
                    emoji: 'üçö', 
                    price: 0.12, 
                    calories: 130, 
                    protein: 2.7, 
                    carbs: 28, 
                    fats: 0.3 
                },
                'Arroz integral': { 
                    category: 'Cereales', 
                    emoji: 'üçö', 
                    price: 0.18, 
                    calories: 111, 
                    protein: 2.6, 
                    carbs: 23, 
                    fats: 0.9 
                },
                'Pan integral': { 
                    category: 'Cereales', 
                    emoji: 'üçû', 
                    price: 0.25, 
                    calories: 265, 
                    protein: 9, 
                    carbs: 48, 
                    fats: 3.2 
                },
                'Pan de molde integral': { 
                    category: 'Cereales', 
                    emoji: 'üçû', 
                    price: 0.30, 
                    calories: 265, 
                    protein: 9, 
                    carbs: 48, 
                    fats: 3.2 
                },
                'Tostada integral': { 
                    category: 'Cereales', 
                    emoji: 'üçû', 
                    price: 0.20, 
                    calories: 265, 
                    protein: 9, 
                    carbs: 48, 
                    fats: 3.2 
                },
                'Tostadas de centeno': { 
                    category: 'Cereales', 
                    emoji: 'üçû', 
                    price: 0.25, 
                    calories: 391, 
                    protein: 13, 
                    carbs: 60.1, 
                    fats: 7.6 
                },
                'Tortillas de avena': { 
                    category: 'Cereales', 
                    emoji: 'ü•û', 
                    price: 0.30, 
                    calories: 150, 
                    protein: 5, 
                    carbs: 25, 
                    fats: 3 
                },
                'Tortas de arroz': { 
                    category: 'Cereales', 
                    emoji: 'üçò', 
                    price: 0.20, 
                    calories: 35, 
                    protein: 0.7, 
                    carbs: 7.3, 
                    fats: 0.3 
                },
                'Mix de cereales sin az√∫car': { 
                    category: 'Cereales', 
                    emoji: 'üåæ', 
                    price: 0.35, 
                    calories: 389, 
                    protein: 10.1, 
                    carbs: 74.1, 
                    fats: 4.1 
                },
                'Muesli sin az√∫car': { 
                    category: 'Cereales', 
                    emoji: 'ü•£', 
                    price: 0.40, 
                    calories: 164, 
                    protein: 9.3, 
                    carbs: 64, 
                    fats: 13 
                },
                
                // Tub√©rculos
                'Patata cocida': { 
                    category: 'Tub√©rculos', 
                    emoji: 'ü•î', 
                    price: 0.15, 
                    calories: 86, 
                    protein: 1.7, 
                    carbs: 20, 
                    fats: 0.1 
                },
                'Boniato': { 
                    category: 'Tub√©rculos', 
                    emoji: 'üç†', 
                    price: 0.35, 
                    calories: 86, 
                    protein: 1.6, 
                    carbs: 20, 
                    fats: 0.1 
                },
                
                // Verduras
                'Br√≥coli': { 
                    category: 'Verduras', 
                    emoji: 'ü•¶', 
                    price: 0.35, 
                    calories: 34, 
                    protein: 2.8, 
                    carbs: 6.6, 
                    fats: 0.4 
                },
                'Espinacas crudas': { 
                    category: 'Verduras', 
                    emoji: 'ü•¨', 
                    price: 0.45, 
                    calories: 23, 
                    protein: 2.9, 
                    carbs: 3.6, 
                    fats: 0.4 
                },
                'Can√≥nigos': { 
                    category: 'Verduras', 
                    emoji: 'ü•¨', 
                    price: 0.55, 
                    calories: 21, 
                    protein: 2, 
                    carbs: 3.6, 
                    fats: 0.4 
                },
                'Tomate': { 
                    category: 'Verduras', 
                    emoji: 'üçÖ', 
                    price: 0.25, 
                    calories: 18, 
                    protein: 0.9, 
                    carbs: 3.9, 
                    fats: 0.2 
                },
                'Tomate Cherry': { 
                    category: 'Verduras', 
                    emoji: 'üçÖ', 
                    price: 0.55, 
                    calories: 18, 
                    protein: 0.9, 
                    carbs: 3.9, 
                    fats: 0.2 
                },
                'Zanahoria': { 
                    category: 'Verduras', 
                    emoji: 'ü•ï', 
                    price: 0.20, 
                    calories: 41, 
                    protein: 0.9, 
                    carbs: 9.6, 
                    fats: 0.2 
                },
                'Pepino': { 
                    category: 'Verduras', 
                    emoji: 'ü•í', 
                    price: 0.30, 
                    calories: 16, 
                    protein: 0.7, 
                    carbs: 3.6, 
                    fats: 0.1 
                },
                'Calabac√≠n': { 
                    category: 'Verduras', 
                    emoji: 'ü•í', 
                    price: 0.35, 
                    calories: 17, 
                    protein: 1.2, 
                    carbs: 3.1, 
                    fats: 0.3 
                },
                'Calabaza': { 
                    category: 'Verduras', 
                    emoji: 'üéÉ', 
                    price: 0.40, 
                    calories: 26, 
                    protein: 1, 
                    carbs: 6.5, 
                    fats: 0.1 
                },
                'Hojas verdes': { 
                    category: 'Verduras', 
                    emoji: 'ü•¨', 
                    price: 0.40, 
                    calories: 15, 
                    protein: 1, 
                    carbs: 3, 
                    fats: 0.1 
                },
                'Ensalada': { 
                    category: 'Verduras', 
                    emoji: 'ü•ó', 
                    price: 0.50, 
                    calories: 15, 
                    protein: 1, 
                    carbs: 3, 
                    fats: 0.1 
                },
                'Verduras': { 
                    category: 'Verduras', 
                    emoji: 'ü•ó', 
                    price: 0.35, 
                    calories: 35, 
                    protein: 2, 
                    carbs: 7, 
                    fats: 0.2 
                },
                
                // Frutas
                'Pl√°tano': { 
                    category: 'Frutas', 
                    emoji: 'üçå', 
                    price: 0.25, 
                    calories: 89, 
                    protein: 1.1, 
                    carbs: 23, 
                    fats: 0.3 
                },
                'Manzana': { 
                    category: 'Frutas', 
                    emoji: 'üçé', 
                    price: 0.30, 
                    calories: 52, 
                    protein: 0.3, 
                    carbs: 14, 
                    fats: 0.2 
                },
                'Kiwi': { 
                    category: 'Frutas', 
                    emoji: 'ü•ù', 
                    price: 0.35, 
                    calories: 61, 
                    protein: 1.1, 
                    carbs: 15, 
                    fats: 0.5 
                },
                'Fresas': { 
                    category: 'Frutas', 
                    emoji: 'üçì', 
                    price: 0.65, 
                    calories: 32, 
                    protein: 0.7, 
                    carbs: 7.7, 
                    fats: 0.3 
                },
                'Sand√≠a': { 
                    category: 'Frutas', 
                    emoji: 'üçâ', 
                    price: 0.40, 
                    calories: 30, 
                    protein: 0.6, 
                    carbs: 7.6, 
                    fats: 0.2 
                },
                'Mel√≥n': { 
                    category: 'Frutas', 
                    emoji: 'üçà', 
                    price: 0.35, 
                    calories: 34, 
                    protein: 0.8, 
                    carbs: 8.2, 
                    fats: 0.2 
                },
                'Fruta': { 
                    category: 'Frutas', 
                    emoji: 'üçé', 
                    price: 0.30, 
                    calories: 60, 
                    protein: 0.5, 
                    carbs: 15, 
                    fats: 0.2 
                },
                
                // Legumbres
                'Lentejas': { 
                    category: 'Legumbres', 
                    emoji: 'ü•£', 
                    price: 0.25, 
                    calories: 116, 
                    protein: 9, 
                    carbs: 20, 
                    fats: 0.4 
                },
                'Garbanzos': { 
                    category: 'Legumbres', 
                    emoji: 'ü•£', 
                    price: 0.28, 
                    calories: 164, 
                    protein: 8.9, 
                    carbs: 27.4, 
                    fats: 2.6 
                },
                'Guisantes': { 
                    category: 'Legumbres', 
                    emoji: 'üü¢', 
                    price: 0.30, 
                    calories: 81, 
                    protein: 5.4, 
                    carbs: 14.5, 
                    fats: 0.4 
                },
                'Legumbre': { 
                    category: 'Legumbres', 
                    emoji: 'ü•£', 
                    price: 0.25, 
                    calories: 116, 
                    protein: 9, 
                    carbs: 20, 
                    fats: 0.4 
                },
                
                // Grasas
                'Aceite de oliva': { 
                    category: 'Grasas', 
                    emoji: 'ü´í', 
                    price: 0.85, 
                    calories: 884, 
                    protein: 0, 
                    carbs: 0, 
                    fats: 100 
                },
                'Aguacate': { 
                    category: 'Grasas', 
                    emoji: 'ü•ë', 
                    price: 0.95, 
                    calories: 160, 
                    protein: 2, 
                    carbs: 9, 
                    fats: 15 
                },
                'Nueces': { 
                    category: 'Grasas', 
                    emoji: 'üå∞', 
                    price: 1.20, 
                    calories: 654, 
                    protein: 15.2, 
                    carbs: 13.7, 
                    fats: 65.2 
                },
                'Almendras': { 
                    category: 'Grasas', 
                    emoji: 'üå∞', 
                    price: 1.50, 
                    calories: 579, 
                    protein: 21, 
                    carbs: 21.6, 
                    fats: 49.9 
                },
                'Frutos secos': { 
                    category: 'Grasas', 
                    emoji: 'üå∞', 
                    price: 1.30, 
                    calories: 607, 
                    protein: 20, 
                    carbs: 21, 
                    fats: 54 
                },
                'Ch√≠a': { 
                    category: 'Grasas', 
                    emoji: 'üå±', 
                    price: 0.90, 
                    calories: 486, 
                    protein: 16.5, 
                    carbs: 42.1, 
                    fats: 30.7 
                },
                
                // Bebidas
                'Agua': { 
                    category: 'Bebidas', 
                    emoji: 'üíß', 
                    price: 0.01, 
                    calories: 0, 
                    protein: 0, 
                    carbs: 0, 
                    fats: 0 
                },
                
                // Especias y condimentos
                'Canela': { 
                    category: 'Especias', 
                    emoji: 'üåø', 
                    price: 0.50, 
                    calories: 247, 
                    protein: 4, 
                    carbs: 80.6, 
                    fats: 1.2 
                },
                
                // Endulzantes
                'Miel': { 
                    category: 'Endulzantes', 
                    emoji: 'üçØ', 
                    price: 0.70, 
                    calories: 304, 
                    protein: 0.3, 
                    carbs: 82.4, 
                    fats: 0 
                },
                'Mermelada de fresa light': { 
                    category: 'Endulzantes', 
                    emoji: 'üçì', 
                    price: 0.65, 
                    calories: 100, 
                    protein: 0.3, 
                    carbs: 25, 
                    fats: 0 
                },
                
                // Platos preparados
                'Pisto de verduras': { 
                    category: 'Platos preparados', 
                    emoji: 'üçÜüçÖ', 
                    price: 0.85, 
                    calories: 80, 
                    protein: 2.5, 
                    carbs: 10, 
                    fats: 4 
                }
            };

            const categories = {
                'Prote√≠nas': 'ü•©',
                'L√°cteos': 'ü•õ',
                'Cereales': 'üåæ',
                'Tub√©rculos': 'üç†',
                'Verduras': 'ü•¶',
                'Frutas': 'üçé',
                'Legumbres': 'ü•£',
                'Grasas': 'ü•ë',
                'Bebidas': 'üíß',
                'Especias': 'üåø',
                'Endulzantes': 'üçØ',
                'Platos preparados': 'üç≤'
            };

            const calculateSelectedTotals = (foods) => {
                return foods.reduce((acc, food) => ({
                    calories: acc.calories + (food.calories * food.quantity/100),
                    protein: acc.protein + (food.protein * food.quantity/100),
                    carbs: acc.carbs + (food.carbs * food.quantity/100),
                    fats: acc.fats + (food.fats * food.quantity/100)
                }), { calories: 0, protein: 0, carbs: 0, fats: 0 });
            };

            // Estado inicial
            let state = {
                currentMeal: null,
                selectedFoods: { Desayuno: [], Almuerzo: [], Cena: [], Snacks: [] },
                savedDiets: {},
                currentDietIndex: 0,
                theme: localStorage.getItem('theme') || 'light',
                selectedFoodsInModal: [],
                currentShoppingList: 'weekly'
            };

            // Inicializaci√≥n
            const init = () => {
                setTheme(state.theme);
                loadState();
                setupEventListeners();
                renderMeals();
                renderSavedDiets();
                updateTotals();
                generateShoppingList();
            };

            // Configuraci√≥n de eventos
            const setupEventListeners = () => {
                document.getElementById('foodModal').addEventListener('click', e => {
                    if (e.target === document.getElementById('foodModal')) {
                        closeFoodModal();
                    }
                });
            };

            // Manejo del tema
            const setTheme = (theme) => {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                state.theme = theme;
            };

            // Persistencia
            const saveState = () => {
                localStorage.setItem('dietState', JSON.stringify({
                    selectedFoods: state.selectedFoods,
                    savedDiets: state.savedDiets
                }));
            };

            const loadState = () => {
                const saved = localStorage.getItem('dietState');
                if (saved) {
                    const data = JSON.parse(saved);
                    state.selectedFoods = data.selectedFoods || { Desayuno: [], Almuerzo: [], Cena: [], Snacks: [] };
                    state.savedDiets = data.savedDiets || {};
                    
                    // Convertir objetos guardados a arrays si es necesario (para compatibilidad)
                    Object.keys(state.selectedFoods).forEach(meal => {
                        if (!Array.isArray(state.selectedFoods[meal])) {
                            state.selectedFoods[meal] = Object.values(state.selectedFoods[meal]);
                        }
                    });

                    // Cargar la √∫ltima dieta usada
                    if (Object.keys(state.savedDiets).length > 0) {
                        state.currentDietIndex = 0;
                        loadDiet(Object.keys(state.savedDiets)[0]);
                    }
                }
            };

            // Renderizado
            const renderMeals = () => {
                const mealsContainer = document.getElementById('meals');
                mealsContainer.innerHTML = '';
                
                const meals = Object.keys(state.selectedFoods);
                
                for (let i = 0; i < meals.length; i++) {
                    const meal = meals[i];
                    
                    // Crear tarjeta de comida
                    const mealCard = document.createElement('div');
                    mealCard.className = 'meal-card';
                    mealCard.dataset.meal = meal;
                    
                    // T√≠tulo de la comida
                    const emoji = meal === 'Desayuno' ? '‚òÄÔ∏è' : 
                                 meal === 'Almuerzo' ? 'ü•ó' : 
                                 meal === 'Cena' ? 'üåô' : 'üçé';
                    mealCard.innerHTML = `
                        <h3>${emoji} ${meal}</h3>
                        <div class="meal-content" id="${meal}-content"></div>
                    `;
                    
                    // A√±adir evento de clic
                    mealCard.addEventListener('click', (e) => {
                        if (!e.target.closest('input') && !e.target.closest('button')) {
                            state.currentMeal = meal;
                            showFoodModal();
                        }
                    });
                    
                    mealsContainer.appendChild(mealCard);
                    
                    // Renderizar contenido de la comida
                    renderMealContent(meal);
                    
                    // A√±adir bot√≥n para agregar nueva comida (excepto despu√©s de la √∫ltima)
                    if (i < meals.length - 1) {
                        const addBtn = document.createElement('button');
                        addBtn.className = 'add-meal-btn';
                        addBtn.innerHTML = '+ A√±adir comida';
                        addBtn.onclick = () => {
                            const newMealName = prompt('Nombre de la nueva comida:');
                            if (newMealName && newMealName.trim()) {
                                state.selectedFoods[newMealName.trim()] = [];
                                saveState();
                                renderMeals();
                                updateTotals();
                                generateShoppingList();
                            }
                        };
                        mealsContainer.appendChild(addBtn);
                    }
                }
            };

            const renderMealContent = (meal) => {
                const mealContent = document.getElementById(`${meal}-content`);
                if (!mealContent) return;
                
                const mealTotals = state.selectedFoods[meal].reduce((acc, food) => ({
                    calories: acc.calories + (food.calories * food.quantity/100),
                    protein: acc.protein + (food.protein * food.quantity/100),
                    carbs: acc.carbs + (food.carbs * food.quantity/100),
                    fats: acc.fats + (food.fats * food.quantity/100),
                    cost: acc.cost + (food.price * food.quantity/100)
                }), { calories: 0, protein: 0, carbs: 0, fats: 0, cost: 0 });

                // Actualizar macros en el t√≠tulo (a√±adiendo coste)
                const mealCard = mealContent.closest('.meal-card');
                let macroContainer = mealCard.querySelector('.meal-macros');
                if (!macroContainer) {
                    macroContainer = document.createElement('div');
                    macroContainer.className = 'meal-macros';
                    mealCard.querySelector('h3').after(macroContainer);
                }
                macroContainer.innerHTML = `
                    <div class="macro-pill">üî•${mealTotals.calories.toFixed(1)}</div>
                    <div class="macro-pill">üí™${mealTotals.protein.toFixed(1)}g</div>
                    <div class="macro-pill">üçû${mealTotals.carbs.toFixed(1)}g</div>
                    <div class="macro-pill">ü•ë${mealTotals.fats.toFixed(1)}g</div>
                    <div class="macro-pill">üíµ $${mealTotals.cost.toFixed(2)}</div>
                `;

                mealContent.innerHTML = state.selectedFoods[meal].map(food => `
                    <div class="food-item">
                        <div class="food-info">
                            <button class="delete-btn" onclick="App.removeFood('${meal}', '${food.name}')">‚úñ</button>
                            <div style="font-size: 1.2em">${foodDB[food.name].emoji}</div>
                            <div>
                                <div><strong>${food.name}</strong></div>
                                <div class="quantity-actions" style="margin-top: 5px;">
                                    <input type="number" value="${food.quantity}" 
                                        class="quantity-input"
                                        onchange="App.updateQuantity('${meal}', '${food.name}', this.value)"
                                        min="0" step="1">
                                    <span>g</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="food-macros-actions">
                            <div class="macros-cost-container">
                                <div class="macros-grid">
                                    <div class="macro-badge calories">üî• ${(food.calories * food.quantity/100).toFixed(1)} kcal</div>
                                    <div class="macro-badge protein">üí™ ${(food.protein * food.quantity/100).toFixed(1)}g</div>
                                    <div class="macro-badge carbs">üçû ${(food.carbs * food.quantity/100).toFixed(1)}g</div>
                                    <div class="macro-badge fats">ü•ë ${(food.fats * food.quantity/100).toFixed(1)}g</div>
                                </div>
                                <div class="cost-badge">
                                    <div>üíµ</div>
                                    <div>$${(food.price * food.quantity/100).toFixed(2)}</div>
                                </div>
                            </div>
                            
                            <div class="quick-amount-vertical">
                                <button class="quick-amount-btn add" onclick="App.updateQuantity('${meal}', '${food.name}', ${food.quantity + 50})">+50 g</button>
                                <button class="quick-amount-btn remove" onclick="App.updateQuantity('${meal}', '${food.name}', ${Math.max(0, food.quantity - 50)})">-50 g</button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                if (state.selectedFoods[meal].length === 0) {
                    mealContent.innerHTML = '<p style="color: #999;">No hay alimentos a√±adidos</p>';
                }
            };

            const renderSavedDiets = () => {
                const dietNames = Object.keys(state.savedDiets);
                const currentDietName = dietNames[state.currentDietIndex] || 'Nueva dieta';
                document.getElementById('current-diet-title').textContent = currentDietName;
            };

            // Lista de compra
            const generateShoppingList = () => {
                const allFoods = Object.values(state.selectedFoods).flat();
                const foodQuantities = {};
                
                allFoods.forEach(food => {
                    if (!foodQuantities[food.name]) foodQuantities[food.name] = 0;
                    const multiplier = state.currentShoppingList === 'weekly' ? 7 : 30;
                    foodQuantities[food.name] += food.quantity * multiplier;
                });

                const sortedFoods = Object.keys(foodQuantities).sort();
                const listContent = document.getElementById('shopping-list-content');
                
                listContent.innerHTML = sortedFoods.map(food => `
                    <div class="shopping-list-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                ${foodDB[food].emoji} ${food}
                            </div>
                            <div style="font-weight: bold;">${foodQuantities[food].toFixed(0)}g</div>
                        </div>
                    </div>
                `).join('');
                if (sortedFoods.length === 0) {
                    listContent.innerHTML = '<div style="color: #999; text-align: center; padding: 10px;">No hay productos en la lista</div>';
                }
            };

            const showShoppingList = (type) => {
                state.currentShoppingList = type;
                generateShoppingList();
                
                // Actualizar pesta√±as activas
                document.querySelectorAll('.shopping-list-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                event.target.classList.add('active');
            };

            // Modales
            const showFoodModal = () => {
                const modal = document.getElementById('foodModal');
                const content = document.getElementById('modalContent');
                
                // Calcular totales de los seleccionados
                const selectedTotals = calculateSelectedTotals(state.selectedFoodsInModal);
                
                content.innerHTML = `
                    <!-- Columna de selecci√≥n -->
                    <div class="modal-column selection-column">
                        <h2>Selecciona una categor√≠a</h2>
                        <div class="category-grid">
                            ${Object.entries(categories).map(([name, emoji]) => `
                                <div class="category-card" onclick="App.showFoods('${name}')" 
                                    style="background: ${getCategoryColor(name)}">
                                    <div style="font-size: 2em">${emoji}</div>
                                    ${name}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Columna de seleccionados -->
                    <div class="modal-column selected-column">
                        <h3>üõí Seleccionados (${state.selectedFoodsInModal.length})</h3>
                        
                        <!-- A√±adir secci√≥n de totales -->
                        ${state.selectedFoodsInModal.length > 0 ? `
                            <div style="background: rgba(0,0,0,0.05); padding: 10px; border-radius: 8px; margin: 10px 0;">
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; font-size: 0.9em;">
                                    <div>üî• Calor√≠as: ${selectedTotals.calories.toFixed(1)}</div>
                                    <div>üí™ Prote√≠na: ${selectedTotals.protein.toFixed(1)}g</div>
                                    <div>üçû Carbos: ${selectedTotals.carbs.toFixed(1)}g</div>
                                    <div>ü•ë Grasas: ${selectedTotals.fats.toFixed(1)}g</div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div id="modal-selected-list" style="max-height: 60%; overflow-y: auto;">
                            ${state.selectedFoodsInModal.map(food => `
                                <div class="modal-selected-item" data-food="${food.name}">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="flex-grow: 1;">
                                            <div style="font-size: 1.1em; display: flex; align-items: center; gap: 8px;">
                                                ${food.emoji} ${food.name}
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 8px; margin-top: 10px;">
                                                <input type="number" 
                                                    value="${food.quantity}"
                                                    class="quantity-input"
                                                    onchange="App.updateModalQuantity('${food.name}', this.value)"
                                                    min="0">
                                                <span style="font-size: 0.9em; color: var(--text);">gramos</span>
                                            </div>
                                            <div class="macros-cost-container" style="margin-top: 8px;">
                                                <div class="macros-grid">
                                                    <div class="macro-badge calories">
                                                        üî• ${(food.calories * food.quantity/100).toFixed(1)} kcal
                                                    </div>
                                                    <div class="macro-badge protein">
                                                        üí™ ${(food.protein * food.quantity/100).toFixed(1)}g
                                                    </div>
                                                    <div class="macro-badge carbs">
                                                        üçû ${(food.carbs * food.quantity/100).toFixed(1)}g
                                                    </div>
                                                    <div class="macro-badge fats">
                                                        ü•ë ${(food.fats * food.quantity/100).toFixed(1)}g
                                                    </div>
                                                </div>
                                                <div class="cost-badge">
                                                    <div>üíµ</div>
                                                    <div>$${(food.price * food.quantity/100).toFixed(2)}</div>
                                                    <span>coste</span>
                                                </div>
                                            </div>
                                        </div>
                                        <button class="delete-btn" onclick="App.toggleFoodSelection('${food.name}')">
                                            ‚úñ
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ${state.selectedFoodsInModal.length > 0 ? `
                            <button class="btn btn-primary" onclick="App.addSelectedFoods()" 
                                style="width: 100%; margin-top: 20px; padding: 12px; font-size: 1.1em;">
                                ‚ûï A√±adir a ${state.currentMeal}
                            </button>
                        ` : ''}
                    </div>
                `;
                
                modal.style.display = 'flex';
            };

            const showFoods = (category) => {
                const content = document.getElementById('modalContent');
                const foodsInCategory = Object.entries(foodDB)
                    .filter(([_, data]) => data.category === category)
                    .map(([name, data]) => ({ name, ...data }));

                // Calcular totales de los seleccionados
                const selectedTotals = calculateSelectedTotals(state.selectedFoodsInModal);
                
                content.innerHTML = `
                    <!-- Columna de alimentos -->
                    <div class="modal-column selection-column">
                        <button class="btn" onclick="App.showFoodModal()" 
                            style="margin-bottom: 15px; display: flex; align-items: center; gap: 5px;">
                            ‚Üê Volver a categor√≠as
                        </button>
                        <h2>${category}</h2>
                        <div class="food-grid">
                            ${foodsInCategory.map(food => `
                                <div class="food-item-modal 
                                    ${state.selectedFoodsInModal.some(f => f.name === food.name) ? 'selected' : ''}" 
                                    onclick="App.toggleFoodSelection('${food.name}')">
                                    <div style="font-size: 1.5em">${food.emoji}</div>
                                    <div><strong>${food.name}</strong></div>
                                    <div class="food-macros">
                                        <div>üî• ${food.calories}kcal/100g</div>
                                        <div>üí™ ${food.protein}g</div>
                                        <div>üçû ${food.carbs}g</div>
                                        <div>ü•ë ${food.fats}g</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Columna de seleccionados -->
                    <div class="modal-column selected-column">
                        <h3>üõí Seleccionados (${state.selectedFoodsInModal.length})</h3>
                        
                        <!-- A√±adir secci√≥n de totales -->
                        ${state.selectedFoodsInModal.length > 0 ? `
                            <div style="background: rgba(0,0,0,0.05); padding: 10px; border-radius: 8px; margin: 10px 0;">
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; font-size: 0.9em;">
                                    <div>üî• Calor√≠as: ${selectedTotals.calories.toFixed(1)}</div>
                                    <div>üí™ Prote√≠na: ${selectedTotals.protein.toFixed(1)}g</div>
                                    <div>üçû Carbos: ${selectedTotals.carbs.toFixed(1)}g</div>
                                    <div>ü•ë Grasas: ${selectedTotals.fats.toFixed(1)}g</div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div id="modal-selected-list" style="max-height: 60%; overflow-y: auto;">
                            ${state.selectedFoodsInModal.map(food => `
                                <div class="modal-selected-item" data-food="${food.name}">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="flex-grow: 1;">
                                            <div style="font-size: 1.1em; display: flex; align-items: center; gap: 8px;">
                                                ${food.emoji} ${food.name}
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 8px; margin-top: 10px;">
                                                <input type="number" 
                                                    value="${food.quantity}"
                                                    style="width: 80px; padding: 6px; border: 1px solid var(--border);"
                                                    onchange="App.updateModalQuantity('${food.name}', this.value)"
                                                    min="0">
                                                <span style="font-size: 0.9em; color: var(--text);">gramos</span>
                                            </div>
                                            <!-- Mostrar macros por cantidad -->
                                            <div style="font-size: 0.8em; color: var(--text); margin-top: 5px;">
                                                üî• ${(food.calories * food.quantity/100).toFixed(1)} kcal | 
                                                üí™ ${(food.protein * food.quantity/100).toFixed(1)}g | 
                                                üçû ${(food.carbs * food.quantity/100).toFixed(1)}g | 
                                                ü•ë ${(food.fats * food.quantity/100).toFixed(1)}g
                                            </div>
                                        </div>
                                        <button onclick="App.toggleFoodSelection('${food.name}')" 
                                            style="background: none; border: none; cursor: pointer; color: var(--danger); 
                                                margin-left: 10px; font-size: 1.2em;">
                                            ‚úñ
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ${state.selectedFoodsInModal.length > 0 ? `
                            <button class="btn btn-primary" onclick="App.addSelectedFoods()" 
                                style="width: 100%; margin-top: 20px; padding: 12px; font-size: 1.1em;">
                                ‚ûï A√±adir a ${state.currentMeal}
                            </button>
                        ` : ''}
                    </div>
                `;
            };

            const closeFoodModal = () => {
                document.getElementById('foodModal').style.display = 'none';
            };

            // Funcionalidad de alimentos
            const toggleFoodSelection = (foodName) => {
                const existingIndex = state.selectedFoodsInModal.findIndex(f => f.name === foodName);
                
                if (existingIndex > -1) {
                    state.selectedFoodsInModal.splice(existingIndex, 1);
                } else {
                    state.selectedFoodsInModal.push({
                        name: foodName,
                        quantity: 100,
                        ...foodDB[foodName]
                    });
                }
                
                // Mantener la vista actual
                const currentCategory = foodDB[foodName].category;
                if (currentCategory) {
                    showFoods(currentCategory);
                } else {
                    showFoodModal();
                }
            };

            const updateModalQuantity = (foodName, value) => {
                const quantity = Math.max(0, parseInt(value) || 0);
                const foodItem = state.selectedFoodsInModal.find(f => f.name === foodName);
                
                if (foodItem) {
                    foodItem.quantity = quantity;
                    // Volver a renderizar la vista actual para actualizar los totales
                    const currentCategory = foodDB[foodName].category;
                    if (currentCategory) {
                        showFoods(currentCategory);
                    } else {
                        showFoodModal();
                    }
                }
            };

            const addSelectedFoods = () => {
                state.selectedFoodsInModal.forEach(modalFood => {
                    const existingIndex = state.selectedFoods[state.currentMeal]
                        .findIndex(f => f.name === modalFood.name);
                    
                    if (existingIndex > -1) {
                        state.selectedFoods[state.currentMeal][existingIndex].quantity += modalFood.quantity;
                    } else {
                        state.selectedFoods[state.currentMeal].push({
                            name: modalFood.name,
                            quantity: modalFood.quantity,
                            ...foodDB[modalFood.name]
                        });
                    }
                });
                
                state.selectedFoodsInModal = [];
                closeFoodModal();
                saveState();
                renderMeals();
                updateTotals();
                generateShoppingList();
            };

            const updateQuantity = (meal, food, value) => {
                const quantity = Math.max(0, Number(value) || 0);
                const item = state.selectedFoods[meal].find(i => i.name === food);
                if (item) {
                    item.quantity = quantity;
                    saveState();
                    renderMealContent(meal);
                    updateTotals();
                    generateShoppingList();
                }
            };

            const removeFood = (meal, food) => {
                state.selectedFoods[meal] = state.selectedFoods[meal].filter(f => f.name !== food);
                saveState();
                renderMealContent(meal);
                updateTotals();
                generateShoppingList();
            };

            // Funcionalidad de dietas
            const saveDiet = () => {
                const nameInput = document.getElementById('diet-name');
                const name = nameInput.value.trim();
                
                if (!name) {
                    alert('Por favor ingresa un nombre para la dieta');
                    return;
                }
                
                state.savedDiets[name] = JSON.parse(JSON.stringify(state.selectedFoods));
                nameInput.value = '';
                saveState();
                
                // Actualizar √≠ndice actual
                const dietNames = Object.keys(state.savedDiets);
                state.currentDietIndex = dietNames.indexOf(name);
                
                renderSavedDiets();
                
                // Mostrar feedback
                const feedback = document.createElement('div');
                feedback.textContent = '¬°Dieta guardada!';
                feedback.style.position = 'fixed';
                feedback.style.bottom = '20px';
                feedback.style.left = '50%';
                feedback.style.transform = 'translateX(-50%)';
                feedback.style.backgroundColor = 'var(--success)';
                feedback.style.color = 'white';
                feedback.style.padding = '10px 20px';
                feedback.style.borderRadius = '5px';
                feedback.style.zIndex = '1000';
                document.body.appendChild(feedback);
                
                setTimeout(() => {
                    document.body.removeChild(feedback);
                }, 2000);
            };

            const loadDiet = (name) => {
                if (state.savedDiets[name]) {
                    state.selectedFoods = JSON.parse(JSON.stringify(state.savedDiets[name]));
                    saveState();
                    renderMeals();
                    updateTotals();
                    generateShoppingList();
                    document.getElementById('current-diet-title').textContent = name;
                }
            };

            const deleteCurrentDiet = () => {
                const dietNames = Object.keys(state.savedDiets);
                if (dietNames.length === 0) return;
                
                const dietName = dietNames[state.currentDietIndex];
                if (confirm(`¬øEst√°s seguro de que quieres eliminar la dieta "${dietName}"?`)) {
                    delete state.savedDiets[dietName];
                    
                    // Ajustar el √≠ndice actual
                    if (state.currentDietIndex >= Object.keys(state.savedDiets).length) {
                        state.currentDietIndex = Math.max(0, Object.keys(state.savedDiets).length - 1);
                    }
                    
                    // Cargar la siguiente dieta si hay alguna
                    if (Object.keys(state.savedDiets).length > 0) {
                        loadDiet(Object.keys(state.savedDiets)[state.currentDietIndex]);
                    } else {
                        // Resetear a una dieta vac√≠a
                        state.selectedFoods = { Desayuno: [], Almuerzo: [], Cena: [], Snacks: [] };
                        renderMeals();
                        updateTotals();
                        generateShoppingList();
                    }
                    
                    saveState();
                    renderSavedDiets();
                }
            };

            const prevDiet = () => {
                const dietNames = Object.keys(state.savedDiets);
                if (dietNames.length === 0) return;
                
                state.currentDietIndex = (state.currentDietIndex - 1 + dietNames.length) % dietNames.length;
                loadDiet(dietNames[state.currentDietIndex]);
                document.getElementById('current-diet-title').textContent = dietNames[state.currentDietIndex];
            };

            const nextDiet = () => {
                const dietNames = Object.keys(state.savedDiets);
                if (dietNames.length === 0) return;
                
                state.currentDietIndex = (state.currentDietIndex + 1) % dietNames.length;
                loadDiet(dietNames[state.currentDietIndex]);
                document.getElementById('current-diet-title').textContent = dietNames[state.currentDietIndex];
            };

            // C√°lculos
            const updateTotals = () => {
                const totals = Object.values(state.selectedFoods).flat().reduce((acc, food) => ({
                    calories: acc.calories + (food.calories * food.quantity/100),
                    protein: acc.protein + (food.protein * food.quantity/100),
                    carbs: acc.carbs + (food.carbs * food.quantity/100),
                    fats: acc.fats + (food.fats * food.quantity/100),
                    cost: acc.cost + (food.price * food.quantity/100)
                }), { calories: 0, protein: 0, carbs: 0, fats: 0, cost: 0 });

                document.getElementById('total-cal').textContent = totals.calories.toFixed(1);
                document.getElementById('total-pro').textContent = totals.protein.toFixed(1);
                document.getElementById('total-carbs').textContent = totals.carbs.toFixed(1);
                document.getElementById('total-fat').textContent = totals.fats.toFixed(1);
                document.getElementById('total-cost').textContent = totals.cost.toFixed(2);
            };

            // Exportaci√≥n
            const exportPDF = () => {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                
                pdf.setFontSize(18);
                pdf.text('Plan Diet√©tico', 105, 20, { align: 'center' });
                
                let yPos = 30;
                const columnWidth = 90;
                
                // Encabezado
                pdf.setFontSize(12);
                pdf.setTextColor(100);
                pdf.text("Comida", 20, yPos);
                pdf.text("Alimento (gramos)", 60, yPos);
                pdf.text("Macronutrientes", 130, yPos);
                yPos += 8;
                
                // Contenido
                pdf.setFontSize(10);
                Object.entries(state.selectedFoods).forEach(([meal, foods]) => {
                    if (foods.length > 0) {
                        pdf.setFont(undefined, 'bold');
                        pdf.setTextColor(0);
                        pdf.text(`${meal}:`, 20, yPos);
                        pdf.setFont(undefined, 'normal');
                        yPos += 7;
                        
                        foods.forEach(food => {
                            const nutrition = `Cal: ${(food.calories * food.quantity/100).toFixed(1)} | P: ${(food.protein * food.quantity/100).toFixed(1)}g | C: ${(food.carbs * food.quantity/100).toFixed(1)}g | G: ${(food.fats * food.quantity/100).toFixed(1)}g`;
                            pdf.text(`- ${food.name} (${food.quantity}g)`, 25, yPos);
                            pdf.text(nutrition, 60, yPos);
                            yPos += 7;
                            
                            if (yPos > 270) {
                                pdf.addPage();
                                yPos = 20;
                            }
                        });
                        yPos += 5;
                    }
                });
                
                // Totales
                pdf.setFont(undefined, 'bold');
                pdf.setTextColor(0);
                pdf.text('TOTALES DIARIOS:', 20, yPos);
                yPos += 7;
                
                const totals = Object.values(state.selectedFoods).flat().reduce((acc, food) => ({
                    calories: acc.calories + (food.calories * food.quantity/100),
                    protein: acc.protein + (food.protein * food.quantity/100),
                    carbs: acc.carbs + (food.carbs * food.quantity/100),
                    fats: acc.fats + (food.fats * food.quantity/100),
                    cost: acc.cost + (food.price * food.quantity/100)
                }), { calories: 0, protein: 0, carbs: 0, fats: 0, cost: 0 });
                
                pdf.text(`üî• Calor√≠as: ${totals.calories.toFixed(1)} kcal`, 25, yPos);
                yPos += 7;
                pdf.text(`üí™ Prote√≠na: ${totals.protein.toFixed(1)}g`, 25, yPos);
                yPos += 7;
                pdf.text(`üçû Carbohidratos: ${totals.carbs.toFixed(1)}g`, 25, yPos);
                yPos += 7;
                pdf.text(`ü•ë Grasas: ${totals.fats.toFixed(1)}g`, 25, yPos);
                yPos += 7;
                pdf.text(`üíµ Costo total: $${totals.cost.toFixed(2)}`, 25, yPos);
                
                // Lista de compra
                yPos += 15;
                pdf.setFont(undefined, 'bold');
                pdf.text('LISTA DE COMPRA SEMANAL:', 20, yPos);
                yPos += 7;
                
                const allFoods = Object.values(state.selectedFoods).flat();
                const foodQuantities = {};
                
                allFoods.forEach(food => {
                    if (!foodQuantities[food.name]) {
                        foodQuantities[food.name] = 0;
                    }
                    foodQuantities[food.name] += food.quantity * 7 / 100;
                });

                const sortedFoods = Object.keys(foodQuantities).sort();
                pdf.setFont(undefined, 'normal');
                sortedFoods.forEach(food => {
                    pdf.text(`- ${food}: ${foodQuantities[food].toFixed(0)}g`, 25, yPos);
                    yPos += 7;
                    
                    if (yPos > 270) {
                        pdf.addPage();
                        yPos = 20;
                    }
                });
                
                pdf.save('dieta.pdf');
            };

            // Helpers
            const getCategoryColor = (category) => {
                const colors = {
                    'Prote√≠nas': 'rgba(246, 229, 141, 0.3)',
                    'L√°cteos': 'rgba(126, 214, 223, 0.3)',
                    'Cereales': 'rgba(186, 220, 88, 0.3)',
                    'Tub√©rculos': 'rgba(222, 184, 135, 0.3)',
                    'Verduras': 'rgba(106, 176, 76, 0.3)',
                    'Frutas': 'rgba(255, 121, 121, 0.3)',
                    'Legumbres': 'rgba(210, 180, 140, 0.3)',
                    'Grasas': 'rgba(255, 190, 118, 0.3)',
                    'Bebidas': 'rgba(100, 149, 237, 0.3)',
                    'Especias': 'rgba(139, 69, 19, 0.3)',
                    'Endulzantes': 'rgba(255, 215, 0, 0.3)',
                    'Platos preparados': 'rgba(255, 165, 0, 0.3)'
                };
                return colors[category] || 'rgba(248, 249, 250, 0.3)';
            };

            // API p√∫blica
            return {
                init,
                toggleTheme: () => {
                    const newTheme = state.theme === 'light' ? 'dark' : 'light';
                    setTheme(newTheme);
                },
                showFoodModal,
                closeFoodModal,
                showFoods,
                toggleFoodSelection,
                addSelectedFoods,
                updateQuantity,
                removeFood,
                saveDiet,
                loadDiet,
                deleteCurrentDiet,
                prevDiet,
                nextDiet,
                showShoppingList,
                exportPDF,
                updateModalQuantity,
                calculateSelectedTotals
            };
        })();

         // C√≥digo mejorado para el scroll sincronizado
        document.addEventListener('DOMContentLoaded', () => {
            const leftColumn = document.querySelector('.container > div:first-child');
            const rightColumn = document.querySelector('.totals-section');
            
            if (!leftColumn || !rightColumn) return;

            leftColumn.addEventListener('scroll', () => {
                // Margen de 5px para considerar que lleg√≥ al final
                const reachedBottom = leftColumn.scrollHeight - leftColumn.scrollTop <= leftColumn.clientHeight + 5;
                
                if (reachedBottom && rightColumn.scrollTop < rightColumn.scrollHeight - rightColumn.clientHeight) {
                    rightColumn.scrollTop += 15; // Velocidad de scroll
                }
            });
        });

        // Inicializar la aplicaci√≥n cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', App.init);
    </script>
</body>
</html>