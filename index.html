<!DOCTYPE html>
<html lang="es" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dietapp</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* 1. Reset y box-sizing */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            padding: 0;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --background: #f5f6fa;
            --surface: #ffffff;
            --text: #2c3e50;
            --border: #ecf0f1;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --meal-gap: 7px;
        }

        [data-theme="dark"] {
            --primary: #3498db;
            --secondary: #2c3e50;
            --background: #2c3e50;
            --surface: #34495e;
            --text: #ecf0f1;
            --border: #2c3e50;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background: var(--background);
            color: var(--text);
            transition: background 0.3s, color 0.3s;
        }

        .quantity-input {
            width: 60px !important;
            padding: 4px 6px !important;
            text-align: center;
            margin-right: 5px;
        }

        .food-actions {
            display: flex;
            align-items: center;
            gap: 5px;
            min-width: 150px;
            justify-content: flex-end;
        }

        .macro-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin: 2px;
        }

        .macro-badge.calories {
            background: rgba(255, 107, 107, 0.2);
        }

        .macro-badge.protein {
            background: rgba(77, 171, 247, 0.2);
        }

        .macro-badge.carbs {
            background: rgba(254, 202, 87, 0.2);
        }

        .macro-badge.fats {
            background: rgba(120, 224, 143, 0.2);
        }

        .macro-badge.cost {
            background: rgba(159, 90, 253, 0.2);
            height: 100%;
            display: flex;
            align-items: center;
        }

        .food-macros-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            margin-top: 5px;
        }

        .food-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 5px;
            margin: 5px 0;
            animation: none;
            transition:
                transform 0.3s ease,
                box-shadow 0.3s ease;
        }

        .food-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .food-name {
            flex: 1;
            min-width: 150px;
        }

        .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--danger);
            font-size: 1.1em;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .container {
            display: grid;
            gap: 30px;
            max-width: 1200px;
            margin: 0 auto;
            height: 100%;
            padding: 20px 20px 50px;
            /* antes estaba en body */
            overflow: hidden;
        }

        .container>div {
            height: 100%;
            overflow-y: auto;
            scroll-behavior: smooth;
            /* ocultar scrollbar si quieres */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .container>div:first-child {
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding-right: 15px;
        }

        .container>div:first-child::-webkit-scrollbar {
            display: none;
        }

        @media (min-width: 768px) {
            .container {
                grid-template-columns: 2fr 1fr;
                /* antes height: calc(100vh - 40px); */
            }
        }

        h1,
        h2,
        h3 {
            color: var(--primary);
        }

        .diet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }

        .meal-grid {
            display: flex;
            flex-direction: column;
            gap: var(--meal-gap);
        }

        .meal-card {
            background: var(--surface);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .meal-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .meal-macros {
            position: absolute;
            top: 15px;
            right: 50px;
            /* Cambiado de 15px a 40px para dejar espacio */
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            /* Permitir que se ajusten si hay muchas */
            max-width: 60%;
            /* Limitar el ancho m√°ximo */
        }

        .macro-pill {
            background: rgba(0, 0, 0, 0.1);
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.9em;
        }

        .add-meal-container {
            text-align: center;
            margin: 20px 0;
        }

        .add-meal-btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .add-meal-btn:hover {
            background: var(--primary);
        }

        .quick-amount {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .quick-amount-btn {
            padding: 5px 10px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
            flex: 1;
        }

        .quick-amount-btn.add {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .quick-amount-btn.remove {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .quick-amount-btn:hover {
            transform: translateY(-2px);
            opacity: 0.7;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .food-macros-actions {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
        }

        .macros-cost-container {
            display: flex;
            gap: 5px;
        }

        .quick-amount-vertical {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-left: 5px;
        }

        .macros-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            flex: 1;
        }

        .cost-badge {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(159, 90, 253, 0.2);
            border-radius: 12px;
            margin-left: 5px;
            padding: 0 10px;
            min-width: 70px;
        }

        .nutrition-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            background: var(--secondary);
            color: white;
            margin: 2px;
            font-size: 0.9em;
        }

        .diet-variants {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .diet-variant {
            min-width: 200px;
            background: var(--surface);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .food-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #modal-selected-list::-webkit-scrollbar {
            width: 5px;
            background: transparent;
        }

        #modal-selected-list::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        .modal-content {
            background: transparent;
            padding: 0;
            display: flex;
            gap: 20px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            border: none;
            box-shadow: none;
            overflow: hidden !important;
        }

        .modal-column {
            background: var(--surface);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            flex: 1;
            overflow: auto;
        }

        .selection-column {
            flex: 4;
            border: 1px solid var(--secondary);
        }

        .selected-column {
            flex: 1.7;
            height: 90vh;
            display: flex;
            flex-direction: column;
            border: 2px solid var(--primary);
            position: relative;
            padding-bottom: 80px;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            justify-content: center;
            margin-top: 30px;
        }

        .add-button-container {
            position: absolute;
            bottom: 20px;
            left: 0px;
            right: 0px;
            background: var(--surface);
            padding: 0px 20px;
            border-top: 1px solid var(--border);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        .category-card {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
            background: rgba(0, 0, 0, 0.05);
        }

        .category-card:hover {
            transform: translateY(-3px);
            background: rgba(0, 0, 0, 0.1);
        }

        .food-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(95px, 1fr));
            gap: 8px;
        }

        .food-item-modal {
            padding: 10px;
            border-radius: 10px;
            border: 1.5px solid rgba(44, 62, 80, 0.10);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                border-color 0.3s ease !important;
            cursor: pointer;
            background: var(--surface);
            text-align: center;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            z-index: 1;
        }

        .food-item-modal:hover {
            transform: translateY(-5px) rotate(-3deg) scale(1.1);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            will-change: transform;
            background: rgb(238, 238, 238);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .food-item-modal:active {
            animation: 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55)forwards;
            transform: scale(0.98);
        }

        @keyframes spinZoom {
            0% {
                transform: scale(1) rotate(0);
            }

            30% {
                transform: scale(1.3) rotate(180deg);
            }

            70% {
                transform: scale(0.9) rotate(340deg);
            }

            100% {
                transform: scale(1) rotate(360deg);
            }
        }

        @keyframes clickEffect {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(0.95);
            }

            100% {
                transform: scale(1);
            }
        }

        .click-animation {
            animation: clickEffect 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        }

        /* Animaci√≥n al a√±adir ingrediente */
        @keyframes popIn {
            0% {
                transform: scale(0.95);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes foodItemClickAnimation {
            0% {
                transform: scale(1);
                border-color: transparent;
            }

            30% {
                transform: scale(0.95);
            }

            70% {
                transform: scale(1.05);
                background: rgba(76, 175, 80, 0.1);
            }

            100% {
                transform: scale(1);
                border-color: var(--success);
            }
        }

        /* Animation class that will be applied on click */
        .food-item-modal.clicked-animation {
            animation: foodItemClickAnimation 0.4s ease forwards;
            background: rgba(76, 175, 80, 0.1);
            transition: background 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            border-color: var(--success);
        }


        .food-item-modal.selected {
            border-color: var(--success);
            background: rgba(76, 175, 80, 0.1);
        }

        .food-item-modal.selected:hover {
            transform: translateY(-3px);
            background: rgba(76, 175, 80, 0.15);
        }

        .modal-selected-item {
            padding: 10px 4px;
            margin-right: 2px;
            position: relative;
        }

        .modal-selected-item.new-item {
            animation: popIn 0.5s ease-out forwards;
            transform-origin: center;
        }

        .food-item.new-item {
            animation: popIn 0.5s ease-out forwards;
            transform-origin: center;
        }

        @keyframes bounceBack {
            0% {
                transform: translateY(-3px);
            }

            50% {
                transform: translateY(2px);
            }

            100% {
                transform: translateY(0);
            }
        }

        .food-item-modal:not(:hover) {
            transition: all 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            transform: rotate(0) scale(1);
        }

        .food-macros {
            font-size: 0.9em;
            color: var(--text);
            margin-top: 8px;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--surface);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.2em;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }

        .diet-navigation {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .nav-btn {
            padding: 5px 10px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn {
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-primary {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        input[type="text"],
        input[type="number"] {
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 5px;
            background: var(--surface);
            color: var(--text);
            width: 100%;
        }

        .selected {
            background: rgba(52, 152, 219, 0.2);
        }

        .diets-list {
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
            border: 1px solid var(--border);
            border-radius: 5px;
            padding: 5px;
        }

        .diet-list-item {
            padding: 8px;
            cursor: pointer;
            border-radius: 3px;
        }

        .diet-list-item:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .container>.left-column,

        .totals-section {
            height: 100%;
            overflow-y: auto;
            scroll-behavior: smooth;
            /* para los scrollBy program√°ticos */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .container>.left-column::-webkit-scrollbar,

        .totals-section::-webkit-scrollbar {
            display: none;
        }

        .shopping-list {
            position: relative;
            margin-top: 30px;
            background: var(--surface);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .shopping-list h3 {
            margin-top: 0;
        }

        .shopping-list-item {
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            margin: 4px 0;
        }

        .shopping-list-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .shopping-list-tabs {
            display: flex;
            margin-bottom: 10px;
        }

        .shopping-list-tab {
            padding: 8px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            color: var(--text);
        }

        .shopping-list-tab.active {
            border-bottom-color: var(--secondary);
            font-weight: bold;
            color: var(--primary);
        }

        .macro-calculator {
            background: var(--surface);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .calculator-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .macro-input,
        .macro-select {
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 5px;
            background: var(--surface);
            color: var(--text);
            width: 100%;
        }

        .macro-progress {
            margin: 10px 0;
        }



        .progress-fill.protein {
            background: rgba(77, 171, 247, 0.4);
        }

        .progress-fill.carbs {
            background: rgba(254, 202, 87, 0.4);
        }

        .progress-fill.fats {
            background: rgba(120, 224, 143, 0.4);
        }

        .progress-fill[style*="100%"] {
            border-radius: 8px !important;
            /* Radio completo */
            margin-right: 0;
        }

        /* === NUEVOS ESTILOS === */
        .macro-progress-ring {
            width: 100px;
            height: 100px;
            position: relative;
            margin: 0 auto;
        }

        .progress-ring {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            fill: none;
            stroke-width: 6;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.3s ease;
        }

        .macro-info {
            top: 50%;
            left: 50%;
            text-align: center;
            z-index: 1;
        }

        .macro-percent {
            font-size: 1.4em;
            font-weight: bold;
            display: block;
        }

        .macro-emoji {
            font-size: 1.8em;
            margin: 5px 0;
        }

        .calories-cost-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 10px;
            padding: 0;
            margin: 0 0 15px 0 !important;
            gap: 15px;
            margin-bottom: 0 !important;
        }

        .macro-bars-container {
            padding: 0;
            box-shadow: none;

        }

        /* A√±adir este nuevo estilo */
        #macro-results {
            background: var(--surface);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        #modal-selected-list {
            flex: 1;
            /* Ajustar altura considerando el bot√≥n */
            overflow-y: auto;
            /* Mantener auto pero con mejor control */
            padding-bottom: 10px;
            scrollbar-width: thin;
            /* Para Firefox */
        }

        .cost-mini {
            background: rgba(159, 90, 253, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
        }

        .progress-ring-background {
            fill: none;
            stroke-width: 6;
            stroke-linecap: round;
            opacity: 0.2;
            stroke: currentColor;
            /* Heredar color del tema */
        }

        .macro-bar {
            width: 100%;
            background: transparent !important;
            box-shadow: none !important;
            padding: 5px 0 !important;
            border-radius: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            /* Ajusta seg√∫n lo que prefieras */
            border-radius: 12px;
            position: relative;
            background: rgba(0, 0, 0, 0.05);
            /* O rgba(0,0,0,0.1) seg√∫n el dise√±o */
            overflow: hidden;
            /* Usa "hidden" si no necesitas "visible" */
            margin: 5px 0;
        }

        .progress-bar::after {
            content: '';
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        /* Colores con transparencia para el fondo de cada barra */
        .progress-bar.calories {
            background: rgba(255, 107, 107, 0.15);
        }

        .progress-bar.protein {
            background: rgba(77, 171, 247, 0.15);
        }

        .progress-bar.carbs {
            background: rgba(254, 202, 87, 0.15);
        }

        .progress-bar.fats {
            background: rgba(120, 224, 143, 0.15);
        }

        /* Parte completada (mismo color pero s√≥lido) */
        .progress-fill.calories {
            background: #ff6b6b;
        }

        .progress-fill.protein {
            background: #4da7f7;
        }

        .progress-fill.carbs {
            background: #feca57;
        }

        .progress-fill.fats {
            background: #78e08f;
        }



        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
            position: absolute;
            top: 0;
            left: 0;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            /* Si es necesario */
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            /* m√°s alto que .food-modal */
        }

        .progress-fill.calories {
            background: #ff6b6b;
        }

        .progress-fill.protein {
            background: #4da7f7;
        }

        .progress-fill.carbs {
            background: #feca57;
        }

        .progress-fill.fats {
            background: #78e08f;
        }

        .macro-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .macro-label {
            color: white;
            position: absolute;
            z-index: 3;
            text-shadow: 1px 1px 2px rgb(0, 0, 0);
            font-size: 0.9em;
            /* A√±adir para prevenir encogimiento */
            flex-shrink: 0;
            margin-right: 10px;
            top: 50%;
            left: 15px;
            transform: translateY(-50%);
        }

        .current {
            color: black !important;
            /* Forzar el color negro */
        }

        .macro-numbers {
            color: black !important;
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1em;
            font-weight: bold;
            display: flex;
            gap: 5px;
            padding: 2px 8px;
            border-radius: 12px;
            background: rgb(255, 255, 255);
            /* Fondo semitransparente */
            backdrop-filter: blur(2px);
            /* Efecto de vidrio */
            z-index: 3;
        }

        .svg-text {
            width: 100px;
            /* Ajusta seg√∫n sea necesario */
            height: 50px;
            /* Ajusta seg√∫n sea necesario */
        }

        .svg-text text {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 24px;
            /* Tama√±o del texto */
            font-weight: 800;
            /* Extra bold */
            fill: white;
            /* Color del texto */
            stroke: black;
            /* Color del contorno */
            stroke-width: 2px;
            /* Grosor del contorno */
            paint-order: stroke fill;
            /* Asegura que el contorno se dibuje fuera del texto */
        }

        .progress-bar[data-progress="0"] .macro-label,
        .progress-bar[data-progress="0"] {
            color: var(--primary);
            /* Color del tema */
            text-shadow: none;
            z-index: 3;
        }

        .shopping-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .cost-mini-container {
            position: absolute;
            top: 15px;
            right: 20px;
        }

        .cost-mini {
            background: rgba(159, 90, 253, 0.15);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid rgba(159, 90, 253, 0.2);
            backdrop-filter: blur(2px);
        }

        .shopping-list-tabs {
            margin-bottom: 12px;
        }

        .food-emoji {
            display: inline-block;
            will-change: transform;
            backface-visibility: hidden;
            transform: translateZ(0);
        }

        /* .food-item-modal:hover {
            transform: rotate(-5deg) scale(1.15);
            filter: drop-shadow(0 3px 6px rgba(0,0,0,0.15));
        } */

        @keyframes spinEmoji {
            0% {
                transform: rotate(0deg) scale(1.2);
            }

            100% {
                transform: rotate(360deg) scale(0.9);
            }
        }

        .food-emoji-spin {
            animation: spinEmoji 0.15s linear forwards;
            /* Cambiado a linear y agregado infinite */
            transform-origin: center center;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.8));
        }

        .new-item {
            animation: popIn 0.5s ease-out forwards;
            transform-origin: center;
        }

        .meal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .delete-meal-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--danger);
            font-size: 1.1em;
            position: absolute;
            top: 15px;
            right: 15px;
            /* Posicionamos la cruz a la derecha */
            z-index: 1;
            /* Aseguramos que est√© por encima */
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .meal-card h3 {
            margin-right: 30px;
            /* Dejar espacio para la cruz */
            padding-right: 10px;
            /* Evitar que el texto toque la cruz */
        }

        .delete-meal-btn:hover {
            transform: scale(1.2);
        }

        .modern-arrow {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 10px;
            background: var(--surface);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .modern-arrow::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 10px;
            height: 10px;
            border: 2px solid var(--primary);
            border-left: none;
            border-bottom: none;
        }

        .modern-arrow.prev::before {
            transform: translate(-50%, -50%) rotate(-135deg);
            margin-left: 2px;
        }

        .modern-arrow.next::before {
            transform: translate(-50%, -50%) rotate(45deg);
            margin-left: -2px;
        }

        .modern-arrow:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .modern-arrow:hover::before {
            border-color: white;
        }

        .diet-nav-container {
            display: flex;
            align-items: center;
            gap: 15px;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .diet-title-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0 20px;
        }

        #current-diet-title {
            margin: 0;
            font-size: 1.5em;
            color: var(--primary);
        }

        .edit-icon {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text);
            font-size: 0.9em;
            padding: 5px;
            transition: transform 0.2s;
        }

        .edit-icon:hover {
            transform: scale(1.1);
        }

        /* Botones de acciones */
        .diet-actions {
            display: flex;
            gap: 12px;
            margin-left: auto;
        }

        .centered-title-container {
            position: relative;
            flex: 1;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            max-width: 60%;
            margin: 0 15px;
        }

        #current-diet-title {
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .edit-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text);
            padding: 4px;
            margin-left: 5px;
            transition: transform 0.2s;
        }

        .edit-btn:hover {
            transform: scale(1.1);
        }

        .nav-btn {
            flex-shrink: 0;
            /* Previene que las flechas se encojan */
            /* Mant√©n los estilos originales de .nav-btn aqu√≠ */
        }

        .progress-excess {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 100%;
            background: repeating-linear-gradient(-45deg,
                    rgba(255, 0, 0, 0.4),
                    rgba(255, 0, 0, 0.4) 10px,
                    rgba(255, 50, 50, 0.4) 10px,
                    rgba(255, 50, 50, 0.4) 20px);
            clip-path: inset(0 0 0 100%);
            transition: clip-path 0.3s ease;
            border-radius: 8px;
            z-index: 2;
        }


        .macro-numbers .current .divider .unit {
            transition: color 0.3s ease;

            color: rgb(0, 0, 0);
            /* Color base cuando no tiene clase */
        }

        .macro-numbers .target {
            transition: color 0.3s ease;

            color: rgb(0, 0, 0);
            /* Color base cuando no tiene clase */
        }


        .safe {
            color: var(--success) !important;

        }

        .warning {
            color: var(--warning) !important;

        }

        .danger {
            color: var(--danger) !important;

        }

        /* ==== MODAL DE RECETAS ==== */
        #recipesModal .modal-content,
        #recipeEditorModal .modal-content,
        #recipeDetailModal .modal-content {
            background: #fff;
            border-radius: 18px;
            border: 1.5px solid #e3f0ff;
            box-shadow: 0 8px 32px rgba(44, 62, 80, 0.10);
            padding: 32px 24px 24px 24px;
            max-width: 520px;
            width: 95vw;
            min-width: 320px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 18px;
            position: relative;
            overflow: visible;
        }

        /* T√≠tulos y botones */
        #recipesModal h2,
        #recipeEditorModal h2,
        #recipeDetailModal h2 {
            color: #3498db;
            font-size: 1.5em;
            font-weight: 700;
            margin: 0 0 8px 0;
            text-align: center;
            letter-spacing: 0.5px;
        }

        #recipesModal .btn,
        #recipeEditorModal .btn,
        #recipeDetailModal .btn {
            background: #f5fafd;
            color: #3498db;
            border: none;
            font-weight: 600;
            box-shadow: none;
            transition: background 0.2s, color 0.2s, transform 0.15s;
        }

        #recipesModal .btn:hover,
        #recipeEditorModal .btn:hover,
        #recipeDetailModal .btn:hover {
            background: #e3f0ff;
            color: #43aee5;
            transform: translateY(-2px) scale(1.04);
        }

        /* Bot√≥n de cerrar */
        #recipesModal .btn[onclick*="close"],
        #recipeEditorModal .btn[onclick*="close"],
        #recipeDetailModal .btn[onclick*="close"] {
            background: transparent;
            color: #3498db;
            font-size: 1.3em;
            box-shadow: none;
            padding: 6px 14px;
        }

        #recipesModal .btn[onclick*="close"]:hover,
        #recipeEditorModal .btn[onclick*="close"]:hover,
        #recipeDetailModal .btn[onclick*="close"]:hover {
            background: #e3f0ff;
            color: #43aee5;
        }

        /* Tarjetas de receta */
        .category-card {
            background: #fafdff;
            border: 1.5px solid #e3f0ff;
            border-radius: 14px;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.07);
            color: #3498db;
            transition: transform 0.18s, box-shadow 0.18s, background 0.18s;
        }

        .category-card:hover {
            background: linear-gradient(135deg, #d2f6ef 60%, #e3f0ff 100%);
            transform: translateY(-4px) scale(1.04);
            box-shadow: 0 8px 24px rgba(52, 152, 219, 0.13);
        }

        /* Inputs y buscadores */
        #recipe-search-input,
        #ingredient-food-search,
        #recipeEditorModal input[type="text"],
        #recipeEditorModal textarea,
        #recipeEditorModal select,
        #recipeEditorModal input[type="number"] {
            border-radius: 8px;
            border: 1.5px solid #e3f0ff;
            padding: 10px 14px;
            font-size: 1em;
            background: #fafdff;
            transition: border 0.2s;
        }

        #recipe-search-input:focus,
        #ingredient-food-search:focus,
        #recipeEditorModal input[type="text"]:focus,
        #recipeEditorModal textarea:focus,
        #recipeEditorModal select:focus,
        #recipeEditorModal input[type="number"]:focus {
            border: 1.5px solid #43cea2;
            outline: none;
        }

        /* Lista de ingredientes */
        #recipe-ingredients-list>div {
            background: #f5fafd;
            border-radius: 7px;
            padding: 5px 10px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1em;
            color: #185a9d;
        }

        #recipe-ingredients-list .btn-danger {
            background: #e74c3c;
            color: #fff;
            padding: 2px 10px;
            font-size: 1em;
            margin-left: auto;
            border-radius: 6px;
        }

        #recipe-ingredients-list .btn-danger:hover {
            background: #c0392b;
        }

        /* Bot√≥n guardar receta */
        #recipeEditorModal .btn-primary {
            background: linear-gradient(90deg, #43cea2 0%, #43aee5 100%);
            color: #fff;
            border: none;
            font-weight: 600;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 1.08em;
            padding: 10px 0;
            width: 100%;
        }

        #recipeEditorModal .btn-primary:hover {
            background: linear-gradient(90deg, #43aee5 0%, #43cea2 100%);
            color: #fff;
        }

        /* Detalle de receta */
        #recipeDetailModal .modal-content {
            border: 1.5px solid #43cea2;
            background: linear-gradient(135deg, #fafdff 80%, #d2f6ef 100%);
        }

        #recipeDetailModal ul {
            padding-left: 18px;
            margin: 0 0 10px 0;
        }

        #recipeDetailModal li {
            margin-bottom: 4px;
            font-size: 1em;
            color: #2176ae;
        }

        #recipeDetailModal strong {
            color: #185a9d;
        }

        .recipe-add-btn {
            font-weight: 600;
            border-radius: 8px;
            margin-bottom: 6px;
            font-size: 1em;
            padding: 8px 18px;
            border: none;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.07);
            transition: background 0.2s, color 0.2s, transform 0.15s, box-shadow 0.2s;
            color: #fff;
            background: #b2bec3;
        }

        .recipe-add-btn-desayuno {
            background: #fffde7 !important;
            /* Amarillo muy claro */
            color: #b8860b !important;
        }

        .recipe-add-btn-desayuno:hover {
            background: #fff9c4 !important;
            color: #b8860b !important;
        }

        .recipe-add-btn-almuerzo {
            background: #f1f8e9 !important;
            /* Verde muy claro */
            color: #256029 !important;
        }

        .recipe-add-btn-almuerzo:hover {
            background: #c8e6c9 !important;
            color: #256029 !important;
        }

        .recipe-add-btn-cena {
            background: #e3f2fd !important;
            /* Azul muy claro */
            color: #1565c0 !important;
        }

        .recipe-add-btn-cena:hover {
            background: #bbdefb !important;
            color: #1565c0 !important;
        }

        .recipe-add-btn-snacks {
            background: #fce4ec !important;
            /* Rosa muy claro */
            color: #ad1457 !important;
        }

        .recipe-add-btn-snacks:hover {
            background: #f8bbd0 !important;
            color: #ad1457 !important;
        }

        .meal-card.dragging {
            opacity: 0.5;
        }

        .meal-card.drag-over {
            border: none;
            border-bottom: 3px dashed var(--secondary);
        }

        .meal-drop-zone {
            height: 0;
            border: none;
            border-bottom: 3px dashed transparent;
            /* Oculto por defecto */
            margin: 0 10px;
            transition: border-color 0.2s;
            pointer-events: none;
        }

        .meal-drop-zone.active {
            border-bottom: 3px dashed var(--secondary);
            /* Solo visible al arrastrar */
            pointer-events: auto;
        }

        .meal-card.collapsed {
            max-height: 60px;
            min-height: 60;
            overflow: hidden;
            padding-bottom: 0 !important;
            padding-top: 0 !important;
            padding-left: 15px !important;
            padding-right: 15px !important;
            opacity: 0.7;
            cursor: pointer;
            transition: max-height 0.25s, opacity 0.2s;
        }

        .meal-card.collapsed .meal-content,
        .meal-card.collapsed .meal-macros {
            display: none !important;
        }

        /* Modal para crear/editar alimento personalizado */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            /* m√°s alto que .food-modal */
        }

        .modal-content {
            background: transparent;
            padding: 0;
            display: flex;
            gap: 20px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            border: none;
            box-shadow: none;
            overflow: hidden !important;
        }

        .modal-column {
            background: var(--surface);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            flex: 1;
            overflow: auto;
        }

        /* Modal para crear/editar alimento personalizado */
        #foodEditorModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        #foodEditorModal .modal-content {
            max-width: 400px;
            flex-direction: column;
            background: var(--surface);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        #food-editor-title {
            margin: 0 0 15px 0;
            font-size: 1.5em;
            color: var(--primary);
            text-align: center;
        }

        #foodEditorModal input,
        #foodEditorModal select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
            border-radius: 5px;
            background: var(--surface);
            color: var(--text);
            font-size: 1em;
        }

        #foodEditorModal button.btn {
            padding: 10px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s, transform 0.2s;
        }

        #foodEditorModal button.btn-primary {
            background: var(--secondary);
            color: white;
        }

        #foodEditorModal button.btn-primary:hover {
            background: var(--primary);
        }

        #foodEditorModal button.btn-danger {
            background: var(--danger);
            color: white;
        }

        #foodEditorModal button.btn-danger:hover {
            background: rgba(231, 76, 60, 0.9);
        }

        #foodEditorModal .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            color: var(--text);
        }

        #foodEditorModal .close-btn:hover {
            color: var(--danger);
        }

        .food-item-modal .btn.btn-primary,
        .food-item-modal .btn.btn-danger {
            background: none !important;
            color: #3498db !important;
            border: none !important;
            box-shadow: none !important;
            padding: 2px 2px !important;
            border-radius: 25% !important;
            font-size: 1em !important;
            transition: background 0.18s, color 0.18s, transform 0.15s;
        }

        .food-item-modal .btn.btn-danger {
            color: #e74c3c !important;
        }

        .food-item-modal .btn.btn-primary:hover,
        .food-item-modal .btn.btn-danger:hover {
            background: #e3f0ff !important;
            color: #43aee5 !important;
            transform: translateY(-2px) scale(1.04);
        }

        .intolerant-food {
            background: #ffeaea !important;
            border-color: #e74c3c !important;
            box-shadow: 0 0 0 2px #e74c3c33;
        }

        .intolerancias-btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 8px;
            justify-content: center;
        }

        .intolerancia-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #f5fafd;
            border: 2.5px solid #e3f0ff;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            flex-direction: column;
            box-shadow: 0 2px 8px rgba(44, 62, 80, 0.07);
            cursor: pointer;
            transition:
                background 0.18s,
                border-color 0.18s,
                transform 0.15s,
                box-shadow 0.18s;
            padding: 0;
            outline: none;
            margin-bottom: 2px;
            overflow: visible;
        }

        .intolerancia-btn .intolerancia-emoji {
            font-size: 2em;
            z-index: 2;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -60%);
            pointer-events: none;
        }

        .intolerancia-curved-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .intolerancia-curved-text text {
            font-size: 1.4em;
            fill: #3498db;
            font-weight: 700;
            letter-spacing: 1.5px;
        }

        .intolerancia-btn.selected,
        .intolerancia-btn.active {
            background: #ffeaea;
            border-color: #e74c3c;
            box-shadow: 0 2px 12px #e74c3c22;
            transform: scale(1.08);
        }

        .intolerancia-btn.selected .intolerancia-curved-text text,
        .intolerancia-btn.active .intolerancia-curved-text text {
            fill: #e74c3c;
        }

        .intolerancia-btn:hover:not(.selected):not(.active) {
            background: #e3f0ff;
            border-color: #43aee5;
            transform: scale(1.04);
        }

        .intolerancias-menu {
            margin-bottom: 12px;
            background: #e3f0ff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(44, 62, 80, 0.06);
            overflow: hidden;
            transition: box-shadow 0.2s;
        }

        .intolerancias-header {
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1em;
            padding: 12px 18px;
            color: #185a9d;
            background: #e3f0ff;
            user-select: none;
            transition: background 0.2s;
            text-align: center;
        }

        .intolerancias-header:hover {
            background: #d2e6fa;
        }

        .intolerancias-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.45s cubic-bezier(.4, 0, .2, 1), padding 0.3s;
            padding: 0 18px;
            background: #fafdff;
        }

        .intolerancias-menu.open .intolerancias-content {
            max-height: 400px;
            /* suficiente para todos los botones */
            padding: 16px 18px 18px 18px;
        }

        .modal-intolerancias-menu {
            margin-top: 10px;
            /* M√°s espacio arriba */
            margin-bottom: 1px;
            /* Menos espacio abajo */
        }
    </style>
</head>

<body>
    <button class="theme-toggle" onclick="App.toggleTheme()" aria-label="Cambiar tema claro/oscuro">üåì</button>

    <h1 style="text-align: center;">üçé Dietapp</h1>

    <div class="container">
        <div>
            <div class="diet-header">
                <!-- Contenedor izquierdo (flechas y t√≠tulo) -->
                <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                    <button class="modern-arrow prev" onclick="App.prevDiet()"></button>
                    <!-- Contenedor del t√≠tulo centrado -->
                    <div class="centered-title-container">
                        <h2 id="current-diet-title">Dieta Actual</h2>
                        <button onclick="App.editDietName()" class="edit-btn">‚úèÔ∏è</button>
                    </div>
                    <button class="modern-arrow next" onclick="App.nextDiet()"></button>
                </div>

                <!-- Contenedor derecho (botones de acci√≥n) -->
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="App.createNewDiet()">‚ûï Nueva</button>
                    <button class="btn btn-danger" onclick="App.deleteCurrentDiet()">üóë Eliminar</button>
                    <button class="btn btn-primary" onclick="App.exportPDF()">üìÑ Exportar PDF</button>
                </div>
            </div>
            <div class="meal-grid" id="meals">
                <!-- Las comidas se generar√°n din√°micamente -->
            </div>
            <div class="add-meal-container">
                <button class="add-meal-btn" onclick="App.addMeal()">+ A√±adir comida</button>
            </div>
        </div>


        <aside class="totals-section">
            <!-- Panel para que el usuario marque sus intolerancias -->
            <div class="intolerancias-menu">
                <div class="intolerancias-header"
                    onclick="if (!event.target.closest('.intolerancia-btn')) this.parentElement.classList.toggle('open')">
                    Intolerancias <span style="font-size:1.2em;">‚ö†Ô∏è</span>
                </div>
                <div class="intolerancias-content">
                    <div class="intolerancias-btn-group">
                        <!-- Tus botones de intolerancia aqu√≠ -->
                        <button type="button" class="intolerancia-btn" data-value="gluten">
                            <span class="intolerancia-emoji">üåæ</span>
                            <svg viewBox="0 0 100 100" class="intolerancia-curved-text">
                                <defs>
                                    <path id="circle-gluten" d="M50,6 a44,44 0 1,0 0,88 a44,44 0 1,0 0,-88" />
                                </defs>
                                <text>
                                    <textPath xlink:href="#circle-gluten" startOffset="50%" text-anchor="middle">Gluten
                                    </textPath>
                                </text>
                            </svg>
                        </button>
                        <button type="button" class="intolerancia-btn" data-value="lactosa">
                            <span class="intolerancia-emoji">ü•õ</span>
                            <svg viewBox="0 0 100 100" class="intolerancia-curved-text">
                                <defs>
                                    <path id="circle-lactosa" d="M50,6 a44,44 0 1,0 0,88 a44,44 0 1,0 0,-88" />
                                </defs>
                                <text>
                                    <textPath xlink:href="#circle-lactosa" startOffset="50%" text-anchor="middle">
                                        Lactosa
                                    </textPath>
                                </text>
                            </svg>
                        </button>
                        <button type="button" class="intolerancia-btn" data-value="frutos secos">
                            <span class="intolerancia-emoji">üå∞</span>
                            <svg viewBox="0 0 100 100" class="intolerancia-curved-text">
                                <defs>
                                    <path id="circle-frutossecos" d="M50,6 a44,44 0 1,0 0,88 a44,44 0 1,0 0,-88" />
                                </defs>
                                <text>
                                    <textPath xlink:href="#circle-frutossecos" startOffset="50%" text-anchor="middle">
                                        Frutos
                                        secos</textPath>
                                </text>
                            </svg>
                        </button>
                        <button type="button" class="intolerancia-btn" data-value="huevo">
                            <span class="intolerancia-emoji">ü•ö</span>
                            <svg viewBox="0 0 100 100" class="intolerancia-curved-text">
                                <defs>
                                    <path id="circle-huevo" d="M50,6 a44,44 0 1,0 0,88 a44,44 0 1,0 0,-88" />
                                </defs>
                                <text>
                                    <textPath xlink:href="#circle-huevo" startOffset="50%" text-anchor="middle">Huevo
                                    </textPath>
                                </text>
                            </svg>
                        </button>
                        <button type="button" class="intolerancia-btn" data-value="soja">
                            <span class="intolerancia-emoji">üå±</span>
                            <svg viewBox="0 0 100 100" class="intolerancia-curved-text">
                                <defs>
                                    <path id="circle-soja" d="M50,6 a44,44 0 1,0 0,88 a44,44 0 1,0 0,-88" />
                                </defs>
                                <text>
                                    <textPath xlink:href="#circle-soja" startOffset="50%" text-anchor="middle">Soja
                                    </textPath>
                                </text>
                            </svg>
                        </button>
                        <button type="button" class="intolerancia-btn" data-value="marisco">
                            <span class="intolerancia-emoji">ü¶ê</span>
                            <svg viewBox="0 0 100 100" class="intolerancia-curved-text">
                                <defs>
                                    <path id="circle-marisco" d="M50,6 a44,44 0 1,0 0,88 a44,44 0 1,0 0,-88" />
                                </defs>
                                <text>
                                    <textPath xlink:href="#circle-marisco" startOffset="50%" text-anchor="middle">
                                        Marisco
                                    </textPath>
                                </text>
                            </svg>
                        </button>
                        <button type="button" class="intolerancia-btn" data-value="pescado">
                            <span class="intolerancia-emoji">üêü</span>
                            <svg viewBox="0 0 100 100" class="intolerancia-curved-text">
                                <defs>
                                    <path id="circle-pescado" d="M50,6 a44,44 0 1,0 0,88 a44,44 0 1,0 0,-88" />
                                </defs>
                                <text>
                                    <textPath xlink:href="#circle-pescado" startOffset="50%" text-anchor="middle">
                                        Pescado
                                    </textPath>
                                </text>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Bot√≥n de Recetas -->
            <button class="btn btn-primary recipe-main-btn" id="open-recipes-btn"
                style="width:100%;padding:18px 0;font-size:1.2em;border-radius:14px;background:linear-gradient(90deg,#43cea2 0%,#185a9d 100%);color:white;box-shadow:0 4px 16px rgba(44,62,80,0.10);margin-bottom:18px;display:flex;align-items:center;justify-content:center;gap:12px;">
                <span style="font-size:1.6em;">üìñ</span>
                <span style="font-size:1.1em;font-weight:600;">Recetas</span>
            </button>
            <!-- Modal de Recetas -->
            <div class="modal" id="recipesModal" style="display:none;">
                <div class="modal-content" id="recipesModalContent" style="flex-direction:column;max-width:600px;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
                        <h2 style="margin:0;">üìñ Recetas</h2>
                        <button class="btn" onclick="App.closeRecipesModal()" style="margin-left:10px;">‚úñ</button>
                    </div>
                    <div style="margin-bottom:10px;">
                        <input id="recipe-search-input" type="text" placeholder="Buscar receta..."
                            style="width:100%;padding:8px;border-radius:6px;border:1.5px solid #ccc;"
                            oninput="App.renderRecipesList()">
                    </div>
                    <div id="recipes-list"></div>
                    <button class="btn btn-success" style="margin-top:15px;" onclick="App.openRecipeEditor()">‚ûï
                        Crear
                        receta</button>
                </div>
            </div>
            <!-- Modal de Crear/Editar Receta -->
            <div class="modal" id="recipeEditorModal" style="display:none;">
                <div class="modal-content" id="recipeEditorContent" style="flex-direction:column;max-width:600px;">
                    <div
                        style="display: flex; align-items: center; justify-content: center; position: relative; margin-bottom: 18px;">
                        <button class="btn" onclick="App.closeRecipeEditor()"
                            style="position: absolute; right: 0; top: 50%; transform: translateY(-50%);">‚úñ</button>
                        <h2 id="recipe-editor-title" style="margin: 0 auto; text-align: center; width: 100%;">
                            Crear
                            Receta</h2>
                    </div>
                    <div style="margin-bottom:10px;">
                        <input id="recipe-name-input" type="text" placeholder="Nombre de la receta"
                            style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
                    </div>
                    <div style="margin-bottom:10px;">
                        <textarea id="recipe-desc-input" placeholder="Descripci√≥n/preparaci√≥n"
                            style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;min-height:60px;"></textarea>
                    </div>
                    <div style="margin-bottom:10px;">
                        <label><strong>Ingredientes:</strong></label>
                        <div id="recipe-ingredients-list"></div>
                        <div style="display:flex;gap:5px;margin-top:5px;">
                            <input id="ingredient-food-search" type="text" placeholder="Buscar alimento..."
                                style="flex:3;padding:6px;" autocomplete="off" list="ingredient-food-list">
                            <datalist id="ingredient-food-list"></datalist>
                            <input id="ingredient-qty-input" type="number" min="1" placeholder="g"
                                style="flex:1;padding:6px;">
                            <button class="btn btn-success btn-mini" type="button"
                                onclick="App.addIngredientToRecipe()">‚ûï</button>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="App.saveRecipe()" style="margin-top:10px;">Guardar
                        receta</button>
                </div>
            </div>
            <!-- Modal de Detalle de Receta -->
            <div class="modal" id="recipeDetailModal" style="display:none;">
                <div class="modal-content" id="recipeDetailContent" style="flex-direction:column;max-width:600px;">
                    <div id="recipe-detail-body"></div>
                </div>
            </div>
            <div class="macro-calculator">
                <h2>‚öñÔ∏è Tus Objetivos</h2>
                <div class="calculator-form">
                    <div class="input-group">
                        <label>Edad:</label>
                        <input type="number" id="age" min="15" max="100" class="macro-input">
                    </div>
                    <div class="input-group">
                        <label>Peso (kg):</label>
                        <input type="number" id="weight" class="macro-input">
                    </div>
                    <div class="input-group">
                        <label>Altura (cm):</label>
                        <input type="number" id="height" class="macro-input">
                    </div>
                    <div class="input-group">
                        <label>G√©nero:</label>
                        <select id="gender" class="macro-select">
                            <option value="male">Hombre</option>
                            <option value="female">Mujer</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Actividad:</label>
                        <select id="activity" class="macro-select">
                            <option value="Sedentario">Sedentario</option>
                            <option value="Baja">Baja</option>
                            <option value="Media">Media</option>
                            <option value="Alta">Alta</option>
                            <option value="Extra">Extra</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Objetivo:</label>
                        <select id="goal" class="macro-select">
                            <option value="P√©rdida de peso">Perder peso</option>
                            <option value="Mantenimiento">Mantener peso</option>
                            <option value="Ganancia muscular">Ganar peso</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Resultados (inicialmente ocultos) -->
            <div id="macro-results" style="display: none;">
                <!-- Secci√≥n Calor√≠as y Costo -->

                <div class="progress-bar calories">
                    <div class="progress-fill calories" id="calories-progress"></div>
                    <div class="progress-excess" id="calories-excess"></div>
                    <span class="macro-label">üî• Calor√≠as</span>
                    <span class="macro-numbers">
                        <span id="current-calories" class="current">0</span>
                        <span id="calories-divider" class="divider">/</span>
                        <span id="target-calories" class="target">0</span>
                        <span id="calories-unit" class="unit">kcal</span>
                    </span>
                </div>

                <!-- Prote√≠nas -->
                <div class="progress-bar protein">
                    <div class="progress-fill protein" id="protein-progress"></div>
                    <div class="progress-excess" id="protein-excess"></div>
                    <span class="macro-label">üí™ Prote√≠nas</span>
                    <span class="macro-numbers">
                        <span id="current-protein" class="current">0</span>
                        <span id="protein-divider" class="divider">/</span>
                        <span id="target-protein" class="target">0</span>
                        <span id="protein-unit" class="unit">g</span>
                    </span>
                </div>

                <!-- Carbohidratos -->
                <div class="progress-bar carbs">
                    <div class="progress-fill carbs" id="carbs-progress"></div>
                    <div class="progress-excess" id="carbs-excess"></div>
                    <span class="macro-label">üçû Carbohidratos</span>
                    <span class="macro-numbers">
                        <span id="current-carbs" class="current">0</span>
                        <span id="carbs-divider" class="divider">/</span>
                        <span id="target-carbs" class="target">0</span>
                        <span id="carbs-unit" class="unit">g</span>
                    </span>
                </div>

                <!-- Grasas -->
                <div class="progress-bar fats">
                    <div class="progress-fill fats" id="fats-progress"></div>
                    <div class="progress-excess" id="fats-excess"></div>
                    <span class="macro-label">ü•ë Grasas</span>
                    <span class="macro-numbers">
                        <span id="current-fats" class="current">0</span>
                        <span id="fats-divider" class="divider">/</span>
                        <span id="target-fats" class="target">0</span>
                        <span id="fats-unit" class="unit">g</span>
                    </span>
                </div>
            </div>
            <div class="shopping-list">
                <h3>üõí Lista de Compra</h3>
                <div class="cost-mini-container">
                    <div class="cost-mini">
                        <span>üíµ</span>
                        <span id="total-cost">0</span>‚Ç¨
                    </div>
                </div>
                <div class="shopping-list-tabs">
                    <div class="shopping-list-tab" id="weekly-tab" onclick="App.showShoppingList('weekly', event)">
                        Semanal</div>
                    <div class="shopping-list-tab" id="monthly-tab" onclick="App.showShoppingList('monthly', event)">
                        Mensual</div>
                </div>
                <div class="shopping-list-content" id="shopping-list-content"></div>
            </div>
    </div>
    </div>
    </aside>
    </div>





    </div>

    <!-- Modal de alimentos -->
    <div class="food-modal" id="foodModal">
        <div class="modal-content" id="modalContent">
            <div class="modal-columns-wrapper" style="display:flex;gap:20px;">
                <div id="modal-selection-column" class="modal-column selection-column"></div>
                <div class="modal-column selected-column">
                    <div style="padding: 20px; padding-bottom: 10px;">
                        <h3>üõí Seleccionados (<span id="selected-count"></span>)</h3>
                        <div id="selected-totals"></div>
                    </div>
                    <div id="modal-selected-list"></div>
                    <div class="add-button-container" id="add-button-container"></div>
                </div>
            </div>
        </div>


        <script>

            const App = (() => {
                // Base de datos de alimentos
                const foodDB = {
                    // PROTE√çNAS ANIMALES
                    'Pollo (muslo)': {
                        category: 'Prote√≠nas',
                        emoji: 'üçó',
                        price: 0.70,
                        calories: 239,
                        protein: 27,
                        carbs: 0,
                        fats: 14,
                        intolerancias: []
                    },
                    'Pechuga de pollo': {
                        category: 'Prote√≠nas',
                        emoji: 'üçó',
                        price: 0.75,
                        calories: 165,
                        protein: 31,
                        carbs: 0,
                        fats: 3.6,
                        intolerancias: []
                    },
                    'Huevo': {
                        category: 'Prote√≠nas',
                        emoji: 'ü•ö',
                        price: 0.25,
                        calories: 155,
                        protein: 13,
                        carbs: 1.1,
                        fats: 11,
                        intolerancias: ['huevo']
                    },
                    'Claras': {
                        category: 'Prote√≠nas',
                        emoji: 'ü•ö',
                        price: 0.40,
                        calories: 52,
                        protein: 11,
                        carbs: 0.7,
                        fats: 0.2,
                        intolerancias: ['huevo']
                    },
                    'Salm√≥n fresco': {
                        category: 'Prote√≠nas',
                        emoji: 'üêü',
                        price: 2.10,
                        calories: 208,
                        protein: 20,
                        carbs: 0,
                        fats: 13,
                        intolerancias: ['pescado']
                    },
                    'At√∫n en lata (agua)': {
                        category: 'Prote√≠nas',
                        emoji: 'üêü',
                        price: 0.90,
                        calories: 116,
                        protein: 25.5,
                        carbs: 0,
                        fats: 0.8,
                        intolerancias: ['pescado']
                    },
                    'Salm√≥n ahumado': {
                        category: 'Prote√≠nas',
                        emoji: 'üêü',
                        price: 2.50,
                        calories: 117,
                        protein: 18,
                        carbs: 0,
                        fats: 4.3,
                        intolerancias: ['pescado']
                    },
                    'Pavo': {
                        category: 'Prote√≠nas',
                        emoji: 'ü¶É',
                        price: 1.40,
                        calories: 135,
                        protein: 29,
                        carbs: 0,
                        fats: 1.7,
                        intolerancias: []
                    },
                    'Merluza': {
                        category: 'Prote√≠nas',
                        emoji: 'üêü',
                        price: 1.80,
                        calories: 91,
                        protein: 19,
                        carbs: 0,
                        fats: 1.5,
                        intolerancias: ['pescado']
                    },
                    'Caballa': {
                        category: 'Prote√≠nas',
                        emoji: 'üêü',
                        price: 1.50,
                        calories: 205,
                        protein: 19,
                        carbs: 0,
                        fats: 14,
                        intolerancias: ['pescado']
                    },
                    'Sardinas en lata': {
                        category: 'Prote√≠nas',
                        emoji: 'üêü',
                        price: 0.90,
                        calories: 208,
                        protein: 25,
                        carbs: 0,
                        fats: 11,
                        intolerancias: ['pescado']
                    },
                    'Jam√≥n serrano': {
                        category: 'Prote√≠nas',
                        emoji: 'üçñ',
                        price: 2.50,
                        calories: 185,
                        protein: 30,
                        carbs: 0,
                        fats: 7,
                        intolerancias: ['gluten']
                    },

                    // PROTE√çNAS VEGETALES
                    'Tofu': {
                        category: 'Prote√≠nas',
                        emoji: 'üßà',
                        price: 1.50,
                        calories: 76,
                        protein: 8,
                        carbs: 1.9,
                        fats: 4.8,
                        intolerancias: ['soja']
                    },
                    'Seit√°n': {
                        category: 'Prote√≠nas',
                        emoji: 'üåæ',
                        price: 2.20,
                        calories: 370,
                        protein: 75,
                        carbs: 14,
                        fats: 1.2,
                        intolerancias: ['gluten']
                    },

                    // L√ÅCTEOS
                    'Yogur griego natural': {
                        category: 'L√°cteos',
                        emoji: 'ü•õ',
                        price: 0.45,
                        calories: 59,
                        protein: 10,
                        carbs: 3.6,
                        fats: 0.4,
                        intolerancias: ['lactosa']
                    },
                    'Leche semidesnatada': {
                        category: 'L√°cteos',
                        emoji: 'ü•õ',
                        price: 0.12,
                        calories: 47,
                        protein: 3.4,
                        carbs: 4.8,
                        fats: 1.6,
                        intolerancias: ['lactosa']
                    },
                    'Queso burgos desnatado': {
                        category: 'L√°cteos',
                        emoji: 'üßÄ',
                        price: 1.20,
                        calories: 72,
                        protein: 12,
                        carbs: 2,
                        fats: 1,
                        intolerancias: ['lactosa']
                    },

                    // CEREALES
                    'Copos de avena': {
                        category: 'Cereales',
                        emoji: 'üåæ',
                        price: 0.15,
                        calories: 389,
                        protein: 16.9,
                        carbs: 66.3,
                        fats: 6.9,
                        intolerancias: []
                    },
                    'Arroz integral': {
                        category: 'Cereales',
                        emoji: 'üçö',
                        price: 0.18,
                        calories: 111,
                        protein: 2.6,
                        carbs: 23,
                        fats: 0.9,
                        intolerancias: []
                    },
                    'Quinoa': {
                        category: 'Cereales',
                        emoji: 'üåæ',
                        price: 1.80,
                        calories: 120,
                        protein: 4.4,
                        carbs: 21,
                        fats: 1.9,
                        intolerancias: []
                    },

                    // TUB√âRCULOS
                    'Patata': {
                        category: 'Tub√©rculos',
                        emoji: 'ü•î',
                        price: 0.15,
                        calories: 86,
                        protein: 1.7,
                        carbs: 20,
                        fats: 0.1,
                        intolerancias: []
                    },
                    'Boniato': {
                        category: 'Tub√©rculos',
                        emoji: 'üç†',
                        price: 0.40,
                        calories: 90,
                        protein: 2.0,
                        carbs: 21,
                        fats: 0.3,
                        intolerancias: []
                    },

                    // VERDURAS
                    'Br√≥coli': {
                        category: 'Verduras',
                        emoji: 'ü•¶',
                        price: 0.35,
                        calories: 34,
                        protein: 2.8,
                        carbs: 6.6,
                        fats: 0.4,
                        intolerancias: []
                    },
                    'Espinacas crudas': {
                        category: 'Verduras',
                        emoji: 'ü•¨',
                        price: 0.45,
                        calories: 23,
                        protein: 2.9,
                        carbs: 3.6,
                        fats: 0.4,
                        intolerancias: []
                    },
                    'Calabac√≠n': {
                        category: 'Verduras',
                        emoji: 'ü•í',
                        price: 0.35,
                        calories: 17,
                        protein: 1.2,
                        carbs: 3.1,
                        fats: 0.3,
                        intolerancias: []
                    },

                    // FRUTAS
                    'Pl√°tano': {
                        category: 'Frutas',
                        emoji: 'üçå',
                        price: 0.25,
                        calories: 89,
                        protein: 1.1,
                        carbs: 23,
                        fats: 0.3,
                        intolerancias: []
                    },
                    'Fresas': {
                        category: 'Frutas',
                        emoji: 'üçì',
                        price: 0.65,
                        calories: 32,
                        protein: 0.7,
                        carbs: 7.7,
                        fats: 0.3,
                        intolerancias: []
                    },
                    'Naranja': {
                        category: 'Frutas',
                        emoji: 'üçä',
                        price: 0.35,
                        calories: 47,
                        protein: 0.9,
                        carbs: 12,
                        fats: 0.1,
                        intolerancias: []
                    },

                    // LEGUMBRES
                    'Lentejas': {
                        category: 'Legumbres',
                        emoji: 'ü•£',
                        price: 0.25,
                        calories: 116,
                        protein: 9,
                        carbs: 20,
                        fats: 0.4,
                        intolerancias: []
                    },
                    'Edamame': {
                        category: 'Legumbres',
                        emoji: 'üü¢',
                        price: 1.80,
                        calories: 122,
                        protein: 11,
                        carbs: 10,
                        fats: 5.2,
                        intolerancias: ['soja']
                    },

                    // GRASAS
                    'Aceite de oliva': {
                        category: 'Grasas',
                        emoji: 'ü´í',
                        price: 0.85,
                        calories: 884,
                        protein: 0,
                        carbs: 0,
                        fats: 100,
                        intolerancias: []
                    },
                    'Aguacate': {
                        category: 'Grasas',
                        emoji: 'ü•ë',
                        price: 0.95,
                        calories: 160,
                        protein: 2,
                        carbs: 9,
                        fats: 15,
                        intolerancias: []
                    },

                    // ENDULZANTES
                    'Miel': {
                        category: 'Endulzantes',
                        emoji: 'üçØ',
                        price: 0.70,
                        calories: 304,
                        protein: 0.3,
                        carbs: 82.4,
                        fats: 0,
                        intolerancias: []
                    },
                    'Mermelada de fresa light': {
                        category: 'Endulzantes',
                        emoji: 'üçì',
                        price: 0.65,
                        calories: 100,
                        protein: 0.3,
                        carbs: 25,
                        fats: 0,
                        intolerancias: []
                    },

                    // NUEVOS ALIMENTOS A√ëADIDOS
                    'Alcachofas': {
                        category: 'Verduras',
                        emoji: 'üåø',
                        price: 0.80,
                        calories: 47,
                        protein: 3.3,
                        carbs: 10.5,
                        fats: 0.2,
                        intolerancias: []
                    },
                    'Cusc√∫s integral': {
                        category: 'Cereales',
                        emoji: 'üåæ',
                        price: 0.95,
                        calories: 112,
                        protein: 4.0,
                        carbs: 23,
                        fats: 0.6,
                        intolerancias: ['gluten']
                    },
                    'Tortitas de ma√≠z': {
                        category: 'Cereales',
                        emoji: 'üåΩ',
                        price: 0.50,
                        calories: 387,
                        protein: 8.0,
                        carbs: 80,
                        fats: 2.5,
                        intolerancias: []
                    },

                    // BEBIDAS (categor√≠a existente)
                    'Agua': {
                        category: 'Bebidas',
                        emoji: 'üíß',
                        price: 0.01,
                        calories: 0,
                        protein: 0,
                        carbs: 0,
                        fats: 0,
                        intolerancias: []
                    },
                    'Leche de avena': {
                        category: 'Bebidas',
                        emoji: 'üåæ',
                        price: 0.95,
                        calories: 47,
                        protein: 0.3,
                        carbs: 9.7,
                        fats: 1.0,
                        intolerancias: []
                    },
                    'Leche de almendras': {
                        category: 'Bebidas',
                        emoji: 'ü•§',
                        price: 1.10,
                        calories: 24,
                        protein: 0.5,
                        carbs: 3.0,
                        fats: 1.1,
                        intolerancias: ['frutos secos']
                    },
                    // ESPECIAS (categor√≠a existente)
                    'Canela': {
                        category: 'Especias',
                        emoji: 'üåø',
                        price: 0.50,
                        calories: 247,
                        protein: 4,
                        carbs: 80.6,
                        fats: 1.2,
                        intolerancias: []
                    },
                    'Curry': {
                        category: 'Especias',
                        emoji: 'üåø',
                        price: 0.70,
                        calories: 325,
                        protein: 12.7,
                        carbs: 58.2,
                        fats: 14.0,
                        intolerancias: []
                    },

                    // PLATOS PREPARADOS (categor√≠a existente)
                    'Pisto de verduras': {
                        category: 'Platos preparados',
                        emoji: 'üç≤',
                        price: 0.85,
                        calories: 80,
                        protein: 2.5,
                        carbs: 10,
                        fats: 4,
                        intolerancias: []
                    },
                    'Gazpacho': {
                        category: 'Platos preparados',
                        emoji: 'üç≤',
                        price: 1.20,
                        calories: 55,
                        protein: 1.2,
                        carbs: 10,
                        fats: 1.0,
                        intolerancias: ['gluten']
                    }

                };

                let customFoods = JSON.parse(localStorage.getItem('customFoods') || '{}');
                let editingFoodName = null;

                function getAllFoods() {
                    const deletedFoods = JSON.parse(localStorage.getItem('deletedFoods') || '[]');
                    const all = { ...foodDB, ...customFoods };
                    deletedFoods.forEach(name => { delete all[name]; });
                    return all;
                }

                const categories = {
                    'Prote√≠nas': 'ü•©',
                    'L√°cteos': 'ü•õ',
                    'Cereales': 'üåæ',
                    'Tub√©rculos': 'üç†',
                    'Verduras': 'ü•¶',
                    'Frutas': 'üçé',
                    'Legumbres': 'ü•£',
                    'Grasas': 'ü•ë',
                    'Bebidas': 'üíß',
                    'Especias': 'üåø',
                    'Endulzantes': 'üçØ',
                    'Platos preparados': 'üç≤'
                };

                // Application state
                window.state = {
                    currentMeal: null,
                    selectedFoods: { Desayuno: [], Almuerzo: [], Cena: [], Snacks: [] },
                    savedDiets: {},
                    currentDietIndex: 0,
                    theme: localStorage.getItem('theme') || 'light',
                    selectedFoodsInModal: [],
                    currentShoppingList: 'weekly',
                    userMacros: null,
                    lastAddedItems: [],
                    showMacroResults: false,
                    userIntolerancias: JSON.parse(localStorage.getItem('userIntolerancias') || '[]'),
                    userData: {
                        age: '',
                        weight: '',
                        height: '',
                        gender: 'male',
                        activity: '1.2',
                        goal: 'maintain'
                    },
                    currentCategoryInModal: null
                };

                // ===== INITIALIZATION =====

                const init = () => {
                    setTheme(state.theme);
                    loadState();
                    setupEventListeners();
                    renderMeals();
                    renderSavedDiets();
                    updateTotals();
                    generateShoppingList();
                    loadUserData();
                    updatePeriodLabel();
                    highlightActiveTab();
                    setupUserIntoleranciasBtns();
                };

                // Modal click outside handler
                document.getElementById('foodModal').addEventListener('click', e => {
                    if (e.target === document.getElementById('foodModal')) {
                        closeFoodModal();
                    }
                });

                // Macro input/select change handlers
                document.querySelectorAll('.macro-input, .macro-select').forEach(input => {
                    input.addEventListener('change', () => {
                        saveUserData();
                        saveState();
                    });
                });


                // ===== STATE MANAGEMENT =====

                const saveState = () => {
                    localStorage.setItem('dietState', JSON.stringify({
                        selectedFoods: state.selectedFoods,
                        savedDiets: state.savedDiets,
                        userData: state.userData,
                        userMacros: state.userMacros,
                        showMacroResults: state.showMacroResults,
                        currentDietId: state.currentDietId,
                        recipes: state.recipes
                    }));
                };



                const loadState = () => {
                    const saved = localStorage.getItem('dietState');
                    if (saved) {
                        const data = JSON.parse(saved);
                        state.savedDiets = data.savedDiets || {};
                        state.userMacros = data.userMacros || null;
                        state.showMacroResults = data.showMacroResults || false;
                        state.userData = data.userData || {
                            age: '',
                            weight: '',
                            height: '',
                            gender: 'male',
                            activity: '1.2',
                            goal: 'maintain'
                        };
                        state.currentDietId = data.currentDietId || Object.keys(state.savedDiets)[0];
                        state.recipes = data.recipes || [];

                        // Carga la dieta activa correctamente
                        if (state.currentDietId && state.savedDiets[state.currentDietId]) {
                            state.selectedFoods = JSON.parse(JSON.stringify(state.savedDiets[state.currentDietId]));
                            state.currentDietIndex = Object.keys(state.savedDiets).indexOf(state.currentDietId);
                        } else {
                            // Si no existe, crea una nueva dieta
                            const newName = 'Nueva Dieta 1';
                            state.savedDiets[newName] = { Desayuno: [], Almuerzo: [], Cena: [], Snacks: [] };
                            state.currentDietId = newName;
                            state.selectedFoods = { Desayuno: [], Almuerzo: [], Cena: [], Snacks: [] };
                            state.currentDietIndex = 0;
                        }
                    } else {
                        // Si no hay dietas, crea una nueva dieta
                        const newName = 'Nueva Dieta 1';
                        state.savedDiets = {};
                        state.savedDiets[newName] = { Desayuno: [], Almuerzo: [], Cena: [], Snacks: [] };
                        state.currentDietId = newName;
                        state.selectedFoods = { Desayuno: [], Almuerzo: [], Cena: [], Snacks: [] };
                        state.currentDietIndex = 0;
                        state.recipes = [
                            {
                                name: "Tortilla de Avena",
                                desc: "Mezcla avena, claras y canela. Cocina en sart√©n antiadherente.",
                                ingredients: [
                                    { food: "Claras", qty: 150 },
                                    { food: "Copos de avena", qty: 40 },
                                    { food: "Canela", qty: 2 }
                                ]
                            }
                        ];
                    }
                };

                const saveUserData = () => {
                    state.userData = {
                        age: document.getElementById('age').value,
                        weight: document.getElementById('weight').value,
                        height: document.getElementById('height').value,
                        gender: document.getElementById('gender').value,
                        activity: document.getElementById('activity').value,
                        goal: document.getElementById('goal').value
                    };
                    saveState();

                    // Comprobar si todos los campos requeridos est√°n completos
                    const { age, weight, height } = state.userData;
                    if (age && weight && height) {
                        calculateMacros();
                    } else {
                        // Ocultar objetivos si falta alg√∫n dato
                        const results = document.getElementById('macro-results');
                        if (results) results.style.display = 'none';
                        state.userMacros = null;
                        state.showMacroResults = false;
                        updateTotals();
                    }
                };

                const loadUserData = () => {
                    document.getElementById('age').value = state.userData.age || '';
                    document.getElementById('weight').value = state.userData.weight || '';
                    document.getElementById('height').value = state.userData.height || '';
                    document.getElementById('gender').value = state.userData.gender;
                    document.getElementById('activity').value = state.userData.activity;
                    document.getElementById('goal').value = state.userData.goal;

                    const { age, weight, height } = state.userData;
                    if (age && weight && height) {
                        calculateMacros();
                    } else {
                        // Oculta los objetivos si falta alg√∫n dato
                        const results = document.getElementById('macro-results');
                        if (results) results.style.display = 'none';
                        state.userMacros = null;
                        state.showMacroResults = false;
                        updateTotals();
                    }

                };

                // ===== UI RENDERING =====
                const highlightActiveTab = () => {
                    const weeklyTab = document.getElementById('weekly-tab');
                    const monthlyTab = document.getElementById('monthly-tab');

                    if (state.currentShoppingList === 'weekly') {
                        weeklyTab.classList.add('active');
                        monthlyTab.classList.remove('active');
                    } else {
                        monthlyTab.classList.add('active');
                        weeklyTab.classList.remove('active');
                    }
                };
                // ===== UI RENDERING =====
                const updatePeriodLabel = () => {
                    const label = document.getElementById('cost-period-label');
                    if (label) {
                        label.textContent = state.currentShoppingList === 'weekly' ? 'semanal' : 'mensual';
                    }
                };



                const setTheme = (theme) => {
                    document.documentElement.setAttribute('data-theme', theme);
                    localStorage.setItem('theme', theme);
                    state.theme = theme;
                };


                const renderMeals = () => {
                    const mealsContainer = document.getElementById('meals');
                    mealsContainer.innerHTML = '';

                    const meals = Object.keys(state.selectedFoods);

                    // Drop zone al principio
                    mealsContainer.appendChild(createMealDropZone(0));

                    for (let i = 0; i < meals.length; i++) {
                        const meal = meals[i];
                        const mealCard = createMealCard(meal);
                        mealsContainer.appendChild(mealCard);
                        renderMealContent(meal);

                        // Drop zone entre comidas
                        mealsContainer.appendChild(createMealDropZone(i + 1));
                    }
                };

                function createMealDropZone(index) {
                    const dropZone = document.createElement('div');
                    dropZone.className = 'meal-drop-zone';
                    dropZone.dataset.index = index;

                    dropZone.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        dropZone.classList.add('active');
                    });
                    dropZone.addEventListener('dragleave', () => {
                        dropZone.classList.remove('active');
                    });
                    dropZone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        dropZone.classList.remove('active');
                        const draggedMeal = e.dataTransfer.getData('text/plain');
                        if (draggedMeal) {
                            reorderMealsToIndex(draggedMeal, parseInt(dropZone.dataset.index, 10));
                        }
                    });
                    return dropZone;
                }

                const createMealCard = (meal) => {
                    const mealCard = document.createElement('div');
                    mealCard.className = 'meal-card';
                    mealCard.dataset.meal = meal;
                    mealCard.draggable = true;

                    // Drag events
                    mealCard.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', meal);
                        mealCard.classList.add('dragging');
                        // Colapsar todas, incluida la arrastrada
                        document.querySelectorAll('.meal-card').forEach(card => {
                            card.classList.add('collapsed');
                        });
                    });
                    mealCard.addEventListener('dragend', () => {
                        mealCard.classList.remove('dragging');
                        // Quitar el colapso de todas
                        document.querySelectorAll('.meal-card').forEach(card => {
                            card.classList.remove('collapsed');
                        });
                    });

                    // Permitir soltar sobre otras cards
                    mealCard.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        mealCard.classList.add('drag-over');
                    });
                    mealCard.addEventListener('dragleave', () => {
                        mealCard.classList.remove('drag-over');
                    });
                    mealCard.addEventListener('drop', (e) => {
                        e.preventDefault();
                        mealCard.classList.remove('drag-over');
                        const draggedMeal = e.dataTransfer.getData('text/plain');
                        if (draggedMeal && draggedMeal !== meal) {
                            reorderMeals(draggedMeal, meal);
                        }
                    });

                    const emoji = getMealEmoji(meal);
                    mealCard.innerHTML = `
                        <div class="meal-header">
                            <h3>${emoji} ${meal}</h3>
                            <button class="delete-meal-btn" onclick="App.deleteMeal('${meal}')">‚úñ</button>
                        </div>
                        <div class="meal-content" id="${meal}-content"></div>
                    `;


                    mealCard.onclick = (e) => {
                        if (
                            e.target.classList.contains('delete-meal-btn') ||
                            e.target.classList.contains('delete-btn') ||
                            e.target.classList.contains('quick-amount-btn') ||
                            e.target.closest('.quantity-input')
                        ) {
                            return;
                        }
                        state.currentMeal = meal;
                        showFoodModal();
                    };
                    return mealCard;
                };

                function reorderMeals(draggedMeal, targetMeal) {
                    const meals = Object.keys(state.selectedFoods);
                    const from = meals.indexOf(draggedMeal);
                    const to = meals.indexOf(targetMeal);
                    if (from === -1 || to === -1) return;

                    // Reordena el array
                    meals.splice(to, 0, meals.splice(from, 1)[0]);

                    // Reconstruye el objeto en el nuevo orden
                    const newSelectedFoods = {};
                    meals.forEach(m => newSelectedFoods[m] = state.selectedFoods[m]);
                    state.selectedFoods = newSelectedFoods;

                    // Guarda y renderiza
                    if (state.currentDietId) {
                        state.savedDiets[state.currentDietId] = JSON.parse(JSON.stringify(state.selectedFoods));
                    }
                    saveState();
                    renderMeals();
                    updateTotals();
                    generateShoppingList();
                }

                const getMealEmoji = (meal) => {
                    return meal === 'Desayuno' ? '‚òÄÔ∏è' :
                        meal === 'Almuerzo' ? 'ü•ó' :
                            meal === 'Cena' ? 'üåô' : 'üçé';
                };

                const createAddMealButton = (index) => {
                    const addBtn = document.createElement('button');
                    addBtn.className = 'add-meal-btn';
                    addBtn.onclick = () => {
                        const mealName = Object.keys(state.selectedFoods)[index];
                        state.currentMeal = mealName; // Establecer la comida actual
                        showFoodModal(); // Abrir el modal para seleccionar alimentos
                        if (newMealName && newMealName.trim()) {
                            const mealName = newMealName.trim();
                            const meals = Object.keys(state.selectedFoods);
                            meals.splice(index + 1, 0, mealName); // Insertar en la posici√≥n clicada
                            state.selectedFoods = meals.reduce((acc, meal) => {
                                acc[meal] = state.selectedFoods[meal] || [];
                                return acc;
                            }, {});
                            saveState();
                            renderMeals();
                            updateTotals();
                            generateShoppingList();
                        }
                    };
                    return addBtn;
                };

                const renderMealContent = (meal) => {
                    const mealContent = document.getElementById(`${meal}-content`);
                    if (!mealContent) return;

                    const mealTotals = calculateTotals(state.selectedFoods[meal]);
                    updateMealMacros(meal, mealTotals);

                    // Render food items
                    if (state.selectedFoods[meal].length === 0) {
                        mealContent.innerHTML = '<p style="color: #999;">No hay alimentos a√±adidos</p>';
                        return;
                    }

                    mealContent.innerHTML = state.selectedFoods[meal].map(food =>
                        createFoodItemHTML(food, meal)
                    ).join('');
                };

                const updateMealMacros = (meal, totals) => {
                    const mealCard = document.querySelector(`.meal-card[data-meal="${meal}"]`);
                    if (!mealCard) return;

                    let macroContainer = mealCard.querySelector('.meal-macros');
                    if (!macroContainer) {
                        macroContainer = document.createElement('div');
                        macroContainer.className = 'meal-macros';
                        mealCard.querySelector('h3').after(macroContainer);
                    }

                    macroContainer.innerHTML = `
            <div class="macro-pill">üî•${totals.calories.toFixed(1)}</div>
            <div class="macro-pill">üí™${totals.protein.toFixed(1)}g</div>
            <div class="macro-pill">üçû${totals.carbs.toFixed(1)}g</div>
            <div class="macro-pill">ü•ë${totals.fats.toFixed(1)}g</div>
            <div class="macro-pill">üíµ $${totals.cost.toFixed(2)}</div>
        `;
                };

                const createFoodItemHTML = (food, meal) => {
                    const dbFood = getAllFoods()[food.name];
                    if (!dbFood) {
                        return `
            <div class="food-item" style="background:#ffeaea;border:1.5px solid #e74c3c;">
                <div class="food-info">
                    <button class="delete-btn" onclick="App.removeFood('${meal}', '${food.name}')">‚úñ</button>
                    <div style="font-size: 1.2em">‚ùì</div>
                    <div>
                        <div><strong style="color:#e74c3c;">${food.name}</strong></div>
                        <div style="color:#e74c3c;font-size:0.95em;">No existe en la base de datos</div>
                    </div>
                </div>
            </div>
        `;
                    }
                    return `
        <div class="food-item ${state.lastAddedItems.includes(food.name) ? 'new-item' : ''}">
            <div class="food-info">
                <button class="delete-btn" onclick="App.removeFood('${meal}', '${food.name}')">‚úñ</button>
                <div style="font-size: 1.2em">${dbFood.emoji}</div>
                <div>
                    <div><strong>${food.name}</strong></div>
                    <div class="quantity-actions" style="margin-top: 5px;">
                        <input type="number" value="${food.quantity}" 
                            class="quantity-input"
                            onchange="App.updateQuantity('${meal}', '${food.name}', this.value)"
                            min="0" step="1">
                        <span>g</span>
                    </div>
                </div>
            </div>
            
            <div class="food-macros-actions">
                <div class="macros-cost-container">
                    <div class="macros-grid">
                        <div class="macro-badge calories">üî• ${(food.calories * food.quantity / 100).toFixed(1)} kcal</div>
                        <div class="macro-badge protein">üí™ ${(food.protein * food.quantity / 100).toFixed(1)}g</div>
                        <div class="macro-badge carbs">üçû ${(food.carbs * food.quantity / 100).toFixed(1)}g</div>
                        <div class="macro-badge fats">ü•ë ${(food.fats * food.quantity / 100).toFixed(1)}g</div>
                    </div>
                    <div class="cost-badge">
                        <div>üíµ</div>
                        <div>$${(food.price * food.quantity / 100).toFixed(2)}</div>
                    </div>
                </div>
                
                <div class="quick-amount-vertical">
                    <button class="quick-amount-btn add" onclick="App.updateQuantity('${meal}', '${food.name}', ${food.quantity + 50})">+50 g</button>
                    <button class="quick-amount-btn remove" onclick="App.updateQuantity('${meal}', '${food.name}', ${Math.max(0, food.quantity - 50)})">-50 g</button>
                </div>
            </div>
        </div>
    `;
                };

                // Buscador din√°mico para ingredientes en el editor de recetas
                const setupIngredientFoodSearch = () => {
                    const input = document.getElementById('ingredient-food-search');
                    const datalist = document.getElementById('ingredient-food-list');
                    if (!input || !datalist) return;

                    input.addEventListener('input', function () {
                        const value = this.value.trim().toLowerCase();
                        const allFoods = getAllFoods();
                        datalist.innerHTML = Object.keys(allFoods)
                            .filter(name => name.toLowerCase().includes(value))
                            .slice(0, 20)
                            .map(name => `<option value="${name}">${allFoods[name].emoji} ${name}</option>`)
                            .join('');
                    });
                };

                const renderSavedDiets = () => {
                    const dietNames = Object.keys(state.savedDiets);
                    const currentDietName = dietNames[state.currentDietIndex] || 'Mi primera dieta';
                    document.getElementById('current-diet-title').textContent = currentDietName;
                };

                // ===== MODAL MANAGEMENT =====

                const showFoodModal = () => {
                    state.currentCategoryInModal = null;
                    const modal = document.getElementById('foodModal');
                    const content = document.getElementById('modalContent');
                    updateModalHeights();

                    // Estructura fija de columnas
                    content.innerHTML = `
        <div class="modal-columns-wrapper" style="display:flex;gap:20px;">
            <div id="modal-selection-column" class="modal-column selection-column"></div>
            <div class="modal-column selected-column">
                <div style="padding: 20px; padding-bottom: 10px;">
                    <h3>üõí Seleccionados (<span id="selected-count"></span>)</h3>
                    <div id="selected-totals"></div>
                </div>
                <div id="modal-selected-list"></div>
                <div class="add-button-container" id="add-button-container"></div>
            </div>
        </div>
    `;

                    // Renderiza categor√≠as en la columna de selecci√≥n
                    document.getElementById('modal-selection-column').innerHTML = createCategorySelectionHTML();
                    setupUserIntoleranciasBtns();
                    renderSelectedColumn();
                    modal.style.display = 'flex';
                };

                const createCategorySelectionHTML = () => {
                    return `
    <div style="display:flex;align-items:center;gap:10px;position:relative;">
        <h2 style="margin:0;">Categor√≠as</h2>
        <span style="position:relative;flex:1;">
            <span style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#888;font-size:1.1em;">üîç</span>
            <input 
                id="food-search-input"
                type="text"
                placeholder="Buscar alimento..."
                style="padding:6px 32px 6px 32px;border-radius:6px;border:1.5px solid #ccc;font-size:1em;width:100%;"
                oninput="App.handleFoodSearch(this.value)"
                autocomplete="off"
            >
            <button 
                id="food-search-clear"
                style="display:none;position:absolute;right:5px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:1.1em;color:#e74c3c;"
                onclick="document.getElementById('food-search-input').value='';App.handleFoodSearch('');return false;"
                tabindex="-1"
                aria-label="Limpiar b√∫squeda"
            >‚úñ</button>
        </span>
    </div>
    <!-- Panel para que el usuario marque sus intolerancias -->
            <div class="intolerancias-menu modal-intolerancias-menu">
                <div class="intolerancias-header"
                    onclick="if (!event.target.closest('.intolerancia-btn')) this.parentElement.classList.toggle('open')">
                    Intolerancias <span style="font-size:1.2em;">‚ö†Ô∏è</span>                
                </div>
                <div class="intolerancias-content">
                    <div class="intolerancias-btn-group">
                        <!-- Tus botones de intolerancia aqu√≠ -->
                        <button type="button" class="intolerancia-btn" data-value="gluten">
                            <span class="intolerancia-emoji">üåæ</span>
                            <svg viewBox="0 0 100 100" class="intolerancia-curved-text">
                                <defs>
                                    <path id="circle-gluten" d="M50,6 a44,44 0 1,0 0,88 a44,44 0 1,0 0,-88" />
                                </defs>
                                <text>
                                    <textPath xlink:href="#circle-gluten" startOffset="50%" text-anchor="middle">Gluten
                                    </textPath>
                                </text>
                            </svg>
                        </button>
                        <button type="button" class="intolerancia-btn" data-value="lactosa">
                            <span class="intolerancia-emoji">ü•õ</span>
                            <svg viewBox="0 0 100 100" class="intolerancia-curved-text">
                                <defs>
                                    <path id="circle-lactosa" d="M50,6 a44,44 0 1,0 0,88 a44,44 0 1,0 0,-88" />
                                </defs>
                                <text>
                                    <textPath xlink:href="#circle-lactosa" startOffset="50%" text-anchor="middle">
                                        Lactosa
                                    </textPath>
                                </text>
                            </svg>
                        </button>
                        <button type="button" class="intolerancia-btn" data-value="frutos secos">
                            <span class="intolerancia-emoji">üå∞</span>
                            <svg viewBox="0 0 100 100" class="intolerancia-curved-text">
                                <defs>
                                    <path id="circle-frutossecos" d="M50,6 a44,44 0 1,0 0,88 a44,44 0 1,0 0,-88" />
                                </defs>
                                <text>
                                    <textPath xlink:href="#circle-frutossecos" startOffset="50%" text-anchor="middle">
                                        Frutos
                                        secos</textPath>
                                </text>
                            </svg>
                        </button>
                        <button type="button" class="intolerancia-btn" data-value="huevo">
                            <span class="intolerancia-emoji">ü•ö</span>
                            <svg viewBox="0 0 100 100" class="intolerancia-curved-text">
                                <defs>
                                    <path id="circle-huevo" d="M50,6 a44,44 0 1,0 0,88 a44,44 0 1,0 0,-88" />
                                </defs>
                                <text>
                                    <textPath xlink:href="#circle-huevo" startOffset="50%" text-anchor="middle">Huevo
                                    </textPath>
                                </text>
                            </svg>
                        </button>
                        <button type="button" class="intolerancia-btn" data-value="soja">
                            <span class="intolerancia-emoji">üå±</span>
                            <svg viewBox="0 0 100 100" class="intolerancia-curved-text">
                                <defs>
                                    <path id="circle-soja" d="M50,6 a44,44 0 1,0 0,88 a44,44 0 1,0 0,-88" />
                                </defs>
                                <text>
                                    <textPath xlink:href="#circle-soja" startOffset="50%" text-anchor="middle">Soja
                                    </textPath>
                                </text>
                            </svg>
                        </button>
                        <button type="button" class="intolerancia-btn" data-value="marisco">
                            <span class="intolerancia-emoji">ü¶ê</span>
                            <svg viewBox="0 0 100 100" class="intolerancia-curved-text">
                                <defs>
                                    <path id="circle-marisco" d="M50,6 a44,44 0 1,0 0,88 a44,44 0 1,0 0,-88" />
                                </defs>
                                <text>
                                    <textPath xlink:href="#circle-marisco" startOffset="50%" text-anchor="middle">
                                        Marisco
                                    </textPath>
                                </text>
                            </svg>
                        </button>
                        <button type="button" class="intolerancia-btn" data-value="pescado">
                            <span class="intolerancia-emoji">üêü</span>
                            <svg viewBox="0 0 100 100" class="intolerancia-curved-text">
                                <defs>
                                    <path id="circle-pescado" d="M50,6 a44,44 0 1,0 0,88 a44,44 0 1,0 0,-88" />
                                </defs>
                                <text>
                                    <textPath xlink:href="#circle-pescado" startOffset="50%" text-anchor="middle">
                                        Pescado
                                    </textPath>
                                </text>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
    <button class="btn btn-success" style="margin:10px 0;width:100%;" onclick="App.openFoodEditor()">‚ûï Nuevo alimento</button>
    <div id="food-category-or-search">
        <div class="category-grid">
            ${Object.entries(categories).map(([name, emoji]) => `
                <div class="category-card" onclick="App.showFoods('${name}')"
                    style="background: ${getCategoryColor(name)}">
                    <div style="font-size: 2em">${emoji}</div>
                    ${name}
                </div>
            `).join('')}
            <div class="category-card" onclick="App.showFoods('Personalizados')" style="background:rgba(159,90,253,0.08)">
                <div style="font-size:2em">üìù</div>
                Personalizados
            </div>
        </div>
    </div>
    `;
                };

                const removeDiacritics = str => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                const renderSelectedColumn = () => {
                    // Actualiza el n√∫mero de seleccionados
                    const count = document.getElementById('selected-count');
                    if (count) count.textContent = state.selectedFoodsInModal.length;

                    // Actualiza los totales
                    const totalsDiv = document.getElementById('selected-totals');
                    if (totalsDiv) totalsDiv.innerHTML = createSelectedTotalsHTML(calculateTotals(state.selectedFoodsInModal));

                    // Actualiza la lista de seleccionados y mantiene el scroll
                    const selectedList = document.getElementById('modal-selected-list');
                    if (selectedList) {
                        const prevScroll = selectedList.scrollTop;
                        selectedList.innerHTML = createSelectedFoodsListHTML();
                        selectedList.scrollTop = prevScroll;
                    }

                    // Actualiza el bot√≥n de a√±adir
                    const addBtnContainer = document.getElementById('add-button-container');
                    if (addBtnContainer) addBtnContainer.innerHTML = createAddButtonHTML();

                    // Limpia la animaci√≥n "new-item" despu√©s de renderizar
                    setTimeout(() => {
                        state.selectedFoodsInModal.forEach(item => { if (item.isNew) item.isNew = false; });
                    }, 400); // 400ms es igual o mayor que la duraci√≥n de la animaci√≥n
                };

                const handleFoodSearch = (query) => {
                    const container = document.getElementById('food-category-or-search');
                    const searchInput = document.getElementById('food-search-input');
                    const search = removeDiacritics(query.trim().toLowerCase());

                    if (!search) {
                        // Si est√° vac√≠o, muestra las categor√≠as
                        container.innerHTML = `
            <div class="category-grid">
                ${Object.entries(categories).map(([name, emoji]) => `
                    <div class="category-card" onclick="App.showFoods('${name}')"
                        style="background: ${getCategoryColor(name)}">
                        <div style="font-size: 2em">${emoji}</div>
                        ${name}
                    </div>
                `).join('')}
            </div>
        `;
                        // NO return aqu√≠, sigue para mostrar/ocultar la cruz
                    } else {
                        // Filtra alimentos por nombre ignorando tildes
                        const results = Object.entries(getAllFoods())
                            .filter(([name, data]) => removeDiacritics(name.toLowerCase()).includes(search))
                            .map(([name, data]) => ({ name, ...data }));

                        if (results.length === 0) {
                            container.innerHTML = `<div style="padding:20px;color:#888;">No se encontraron alimentos.</div>`;
                            // NO return aqu√≠, sigue para mostrar/ocultar la cruz
                        } else {
                            container.innerHTML = `
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                    <button class="btn" onclick="
                        document.getElementById('food-search-input').value = '';
                        App.handleFoodSearch('');
                    ">‚Üê Volver a categor√≠as</button>
                </div>
                <div class="food-grid">
                    ${results.map(food => `
                        <div class="food-item-modal 
    ${state.selectedFoodsInModal.some(f => f.name === food.name) ? 'selected' : ''}
    ${(food.intolerancias && food.intolerancias.some(intol => state.userIntolerancias.includes(intol))) ? 'intolerant-food' : ''}" 
    onclick="App.toggleFoodSelection('${food.name}', event)">
                            <div style="font-size: 1.5em"><span class="food-emoji">${food.emoji}</span></div>
                            <div><strong>${food.name}</strong></div>
                            <div class="food-macros">
                                <div>üî• ${food.calories}kcal/100g</div>
                                <div>üí™ ${food.protein}g</div>
                                <div>üçû ${food.carbs}g</div>
                                <div>ü•ë ${food.fats}g</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
                        }
                    }

                    // Mostrar u ocultar la cruz seg√∫n si hay texto
                    const clearBtn = document.getElementById('food-search-clear');
                    if (clearBtn) {
                        clearBtn.style.display = query.trim() ? 'block' : 'none';
                    }

                    // Actualiza la columna de seleccionados SIEMPRE
                    const selectedColumn = document.querySelector('.modal-column.selected-column');
                    if (selectedColumn) {
                        const selectedTotals = calculateTotals(state.selectedFoodsInModal);
                        const selectedList = document.getElementById('modal-selected-list');
                        if (selectedList) {
                            const prevScroll = selectedList.scrollTop;
                            selectedList.innerHTML = createSelectedFoodsListHTML();
                            selectedList.scrollTop = prevScroll;
                        }
                        const addBtnContainer = selectedColumn.querySelector('.add-button-container');
                        if (addBtnContainer) addBtnContainer.innerHTML = createAddButtonHTML();
                        const totalsDiv = selectedColumn.querySelector('.selected-totals');
                        if (totalsDiv) totalsDiv.outerHTML = createSelectedTotalsHTML(selectedTotals);
                    }
                    renderSelectedColumn();
                };

                const createSelectedTotalsHTML = (totals) => {
                    if (state.selectedFoodsInModal.length === 0) return '';
                    return `
        <div class="selected-totals" style="background: rgba(0,0,0,0.05); padding: 10px; border-radius: 8px; margin: 10px 0;">
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; font-size: 0.9em;">
                <div>üî• Calor√≠as: ${totals.calories.toFixed(1)}</div>
                <div>üí™ Prote√≠na: ${totals.protein.toFixed(1)}g</div>
                <div>üçû Carbos: ${totals.carbs.toFixed(1)}g</div>
                <div>ü•ë Grasas: ${totals.fats.toFixed(1)}g</div>
            </div>
        </div>
    `;
                };

                const createSelectedFoodsListHTML = () => {
                    return state.selectedFoodsInModal.map(food => `
        <div class="modal-selected-item ${food.isNew ? 'new-item' : ''}" data-food="${food.name}" style="padding:10px 4px 10px 4px; margin-right:2px;">
            <!-- Fila 1: Cruz, emoji, nombre, coste -->
            <div style="display: flex; align-items: center; gap: 0px; margin-bottom: 6px;">
                <button class="delete-btn" onclick="App.toggleFoodSelection('${food.name}', event)" 
                    style="margin-right:0px;">‚úñ</button>
                <span class="food-emoji" style="font-size:1.2em; min-width:32px;">${food.emoji}</span>
                <span style="font-weight:600; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; flex:1;">
                    ${food.name}
                </span>
                <span class="macro-badge cost" style="background:none;margin-left:8px; display:flex; align-items:center;">
                    <span>üíµ</span><span style="margin-left:2px;">${(food.price * food.quantity / 100).toFixed(2)}‚Ç¨</span>
                </span>
            </div>
            <!-- Fila 2: Macros a la izquierda, gramos a la derecha -->
            <div style="display: flex; align-items: center; gap: 4px;">
                <span class="macro-badge calories"><span>üî•</span><span style="margin-left:2px;">${Math.round(food.calories * food.quantity / 100)}</span></span>
                <span class="macro-badge protein"><span>üí™</span><span style="margin-left:2px;">${Math.round(food.protein * food.quantity / 100)}</span></span>
                <span class="macro-badge carbs"><span>üçû</span><span style="margin-left:2px;">${Math.round(food.carbs * food.quantity / 100)}</span></span>
                <span class="macro-badge fats"><span>ü•ë</span><span style="margin-left:2px;">${Math.round(food.fats * food.quantity / 100)}</span></span>
                <span style="display:flex; align-items:center; gap:2px; margin-left:auto;">
                    <input type="number" 
                        value="${food.quantity}"
                        class="quantity-input"
                        style="width:50px;"
                        onchange="App.updateModalQuantity('${food.name}', this.value)"
                        min="0">
                    <span style="font-size:0.95em;color:#888;">g</span>
                </span>
            </div>
        </div>
    `).join('');
                };

                // ===== RECETAS =====


                let editingRecipeIndex = null;
                let tempIngredients = [];
                const deleteRecipe = idx => {
                    if (confirm('¬øSeguro que quieres eliminar esta receta?')) {
                        state.recipes.splice(idx, 1);
                        saveState();
                        renderRecipesList();
                    }
                };
                const openRecipesModal = () => {
                    document.getElementById('recipesModal').style.display = 'flex';
                    renderRecipesList();
                    document.getElementById('recipe-search-input').value = '';
                };
                const closeRecipesModal = () => {
                    document.getElementById('recipesModal').style.display = 'none';
                };
                const renderRecipesList = () => {
                    const search = (document.getElementById('recipe-search-input').value || '').toLowerCase();
                    const list = document.getElementById('recipes-list');
                    let filtered = state.recipes.filter(r => r.name.toLowerCase().includes(search));
                    if (filtered.length === 0) {
                        list.innerHTML = `<div style="color:#888;padding:20px;">No hay recetas.</div>`;
                        return;
                    }
                    list.innerHTML = `
    <div class="category-grid">
        ${filtered.map((r, i) => {
                        // Calcular macros totales de la receta
                        const totals = r.ingredients.reduce((acc, ing) => {
                            const f = getAllFoods()[ing.food];
                            if (!f) return acc;
                            acc.calories += (f.calories * ing.qty / 100);
                            acc.protein += (f.protein * ing.qty / 100);
                            acc.carbs += (f.carbs * ing.qty / 100);
                            acc.fats += (f.fats * ing.qty / 100);
                            return acc;
                        }, { calories: 0, protein: 0, carbs: 0, fats: 0 });
                        return `
            <div class="category-card" style="position:relative; cursor:pointer; display:flex; flex-direction:column; justify-content:space-between; min-height:180px;" onclick="App.openRecipeDetail(${i})">
                <button class="btn btn-primary" style="position:absolute;top:6px;left:6px;padding:2px 8px;font-size:0.95em;z-index:2;"
                    onclick="event.stopPropagation();App.openRecipeEditor(${i})">‚úèÔ∏è</button>
                <button class="btn btn-danger" style="position:absolute;top:6px;right:6px;padding:2px 8px;font-size:0.95em;z-index:2;"
                    onclick="event.stopPropagation();App.deleteRecipe(${i})">üóëÔ∏è</button>
                <div style="font-size:2em;margin-bottom:4px;">üçΩÔ∏è</div>
                <div style="font-weight:600;margin-bottom:6px;">${r.name}</div>
                <div style="display:flex;justify-content:center;gap:10px;font-size:1em;color:#2176ae; margin-top:auto; padding-top:10px;">
                    <span title="Calor√≠as">üî•${Math.round(totals.calories)}</span>
                    <span title="Prote√≠na">üí™${Math.round(totals.protein)}</span>
                    <span title="Carbohidratos">üçû${Math.round(totals.carbs)}</span>
                    <span title="Grasas">ü•ë${Math.round(totals.fats)}</span>
                </div>
            </div>
            `;
                    }).join('')}
    </div>
`;
                };
                const openRecipeDetail = idx => {
                    const r = state.recipes[idx];
                    let meals = Object.keys(state.selectedFoods);
                    document.getElementById('recipe-detail-body').innerHTML = `
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 18px;">
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-bottom:10px;">
    <button class="btn" title="Editar" style="background:#f5fafd;border:0px solid #e3f0ff;color:#3498db;padding:6px 10px;border-radius:25%;font-size:1.2em;"
        onclick="App.openRecipeEditor(${idx})">‚úèÔ∏è</button>
    <button class="btn" title="Eliminar" style="background:#fff0f0;border:0px solid #f8d7da;color:#e74c3c;padding:6px 10px;border-radius:25%;font-size:1.2em;"
        onclick="App.deleteRecipe(${idx}); App.closeRecipeDetail();">üóëÔ∏è</button>
    </div>
        <h2 style="margin: 0 auto; text-align: center; width: 100%;">${r.name}</h2>
        <button class="btn" onclick="App.closeRecipeDetail()" style="margin-left:10px;align-self:flex-start;">‚úñ</button>
    </div>
    <div style="margin-bottom:18px;">
        <div style="font-weight:600;color:#3498db;margin-bottom:6px;">Ingredientes:</div>
        <ul style="margin-bottom:0;padding-left:18px;">
            ${r.ingredients.map(ing => {
                        if (!getAllFoods()[ing.food]) {
                            return `<li style="margin-bottom:4px;color:#e74c3c;"><b>${ing.food}</b> <span style="color:#888;">- ${ing.qty}g</span> <span style="color:#e74c3c;">(No existe en la base de datos)</span></li>`;
                        }
                        return `${getAllFoods()[ing.food]?.emoji || ''} <b>${ing.food}</b> <span style="color:#888;">- ${ing.qty}g</span>`;
                    }).join('')}
        </ul>
    </div>
    <div style="margin-bottom:18px;">
        <div style="font-weight:600;color:#3498db;margin-bottom:6px;">Pasos / Preparaci√≥n:</div>
        <div style="color:#555;white-space:pre-line;">${r.desc || '<span style="color:#aaa;">Sin descripci√≥n</span>'}</div>
    </div>
    <div>
        <div style="font-weight:600;color:#3498db;margin-bottom:6px;">A√±adir todos los ingredientes a:</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
            ${meals.map(meal => `
                <button class="btn recipe-add-btn recipe-add-btn-${removeDiacritics(meal.toLowerCase())}" onclick="App.addRecipeToMeal(${idx},'${meal}')">
                    ${getMealEmoji(meal)} <span>${meal}</span>
                </button>
            `).join('')}
        </div>
    </div>
`;
                    const modal = document.getElementById('recipeDetailModal');
                    modal.style.display = 'flex';
                    // Forzar reflow
                    void modal.offsetWidth;
                };
                const closeRecipeDetail = () => {
                    document.getElementById('recipeDetailModal').style.display = 'none';
                };
                const addRecipeToMeal = (idx, meal) => {
                    const r = state.recipes[idx];
                    let missingIngredients = [];
                    r.ingredients.forEach(ing => {
                        if (!getAllFoods()[ing.food]) {
                            missingIngredients.push(ing.food);
                            return; // No a√±adir si no existe
                        }
                        // Si ya existe el alimento, suma la cantidad
                        let exists = state.selectedFoods[meal].find(f => f.name === ing.food);
                        if (exists) {
                            exists.quantity += ing.qty;
                        } else {
                            state.selectedFoods[meal].push({
                                name: ing.food,
                                quantity: ing.qty,
                                ...getAllFoods()[ing.food]
                            });
                        }
                    });

                    if (missingIngredients.length > 0) {
                        alert(
                            "Los siguientes ingredientes no existen en la base de datos y no se han a√±adido:\n\n" +
                            missingIngredients.join(", ")
                        );
                    }

                    if (state.currentDietId) {
                        state.savedDiets[state.currentDietId] = JSON.parse(JSON.stringify(state.selectedFoods));
                    }
                    saveState();
                    renderMeals();
                    updateTotals();
                    generateShoppingList();
                    closeRecipeDetail();
                    closeRecipesModal();
                };
                const openRecipeEditor = (idx = null) => {
                    editingRecipeIndex = idx;
                    tempIngredients = idx !== null && state.recipes[idx] ? [...state.recipes[idx].ingredients] : [];
                    document.getElementById('recipe-editor-title').textContent = idx !== null ? 'Editar Receta' : 'Crear Receta';
                    document.getElementById('recipe-name-input').value = idx !== null ? state.recipes[idx].name : '';
                    document.getElementById('recipe-desc-input').value = idx !== null ? state.recipes[idx].desc : '';
                    renderRecipeIngredientsList();
                    setupIngredientFoodSearch();
                    setTimeout(() => {
                        document.getElementById('recipeEditorModal').style.display = 'flex';
                    }, 0);
                };
                const closeRecipeEditor = () => {
                    document.getElementById('recipeEditorModal').style.display = 'none';
                };
                const renderRecipeIngredientsList = () => {
                    document.getElementById('recipe-ingredients-list').innerHTML = tempIngredients.length === 0
                        ? '<div style="color:#888;">Sin ingredientes</div>'
                        : tempIngredients.map((ing, i) => `
            <div>
                <span>${getAllFoods()[ing.food]?.emoji || ''} <b>${ing.food}</b> <span style="color:#888;">- ${ing.qty}g</span></span>
                <button class="btn btn-danger" onclick="App.removeIngredientFromRecipe(${i})">‚úñ</button>
            </div>
        `).join('');
                };
                const addIngredientToRecipe = () => {
                    const food = document.getElementById('ingredient-food-search').value;
                    const qty = parseInt(document.getElementById('ingredient-qty-input').value);
                    if (!getAllFoods()[food] || !qty || qty <= 0) return;
                    tempIngredients.push({ food, qty });
                    renderRecipeIngredientsList();
                    document.getElementById('ingredient-food-search').value = '';
                    document.getElementById('ingredient-qty-input').value = '';
                };
                const removeIngredientFromRecipe = idx => {
                    tempIngredients.splice(idx, 1);
                    renderRecipeIngredientsList();
                    setupIngredientFoodSearch();
                };
                const saveRecipe = () => {
                    const name = document.getElementById('recipe-name-input').value.trim();
                    const desc = document.getElementById('recipe-desc-input').value.trim();
                    if (!name || !Array.isArray(tempIngredients) || tempIngredients.length === 0) {
                        alert('Pon un nombre y al menos un ingrediente.');
                        return;
                    }
                    if (editingRecipeIndex !== null) {
                        state.recipes[editingRecipeIndex] = { name, desc, ingredients: [...tempIngredients] };
                    } else {
                        state.recipes.push({ name, desc, ingredients: [...tempIngredients] });
                    }
                    closeRecipeEditor();
                    renderRecipesList();
                    saveState();
                };

                const createAddButtonHTML = () => {
                    if (state.selectedFoodsInModal.length === 0) return '';

                    return `
            <button class="btn btn-primary" onclick="App.addSelectedFoods()" 
                style="width: 100%; margin-top: 20px; padding: 12px; font-size: 1.1em;">
                ‚ûï A√±adir a ${state.currentMeal}
            </button>
        `;
                };

                const showFoods = (category) => {
                    console.log('showFoods llamada con', category);
                    const content = document.getElementById('modalContent');
                    // Guarda la categor√≠a activa para navegaci√≥n correcta
                    state.currentCategoryInModal = category;

                    // Filtra los alimentos de la categor√≠a
                    let foodsInCategory;
                    if (category === 'Personalizados') {
                        foodsInCategory = Object.entries(customFoods)
                            .map(([name, data]) => ({ name, ...data }));
                    } else {
                        foodsInCategory = Object.entries(getAllFoods())
                            .filter(([name, data]) => data.category === category)
                            .map(([name, data]) => ({ name, ...data }));
                    }

                    const selectedTotals = calculateTotals(state.selectedFoodsInModal);

                    content.innerHTML = `
        <div class="modal-column selection-column">
            <button class="btn" onclick="App.goToCategories()"
    style="margin-bottom: 15px; display: flex; align-items: center; gap: 5px;">
    ‚Üê Volver a categor√≠as
</button>
            <h2>${category}</h2>
            <div class="food-grid">
                ${foodsInCategory.map(food => {
                        const isIntolerant = food.intolerancias && food.intolerancias.some(intol => state.userIntolerancias.includes(intol));
                        return `
                <div class="food-item-modal 
                    ${state.selectedFoodsInModal.some(f => f.name === food.name) ? 'selected' : ''} ${isIntolerant ? 'intolerant-food' : ''}" 
                    onclick="App.toggleFoodSelection('${food.name}', event)"
                    style="position:relative; cursor:pointer; display:flex; flex-direction:column; align-items:center; justify-content:space-between; min-height:130px; padding:8px 4px;">
                    <button class="btn btn-primary" style="position:absolute;top:6px;left:6px;padding:2px 8px;font-size:0.95em;z-index:2;"
                        onclick="event.stopPropagation();App.openFoodEditor('${food.name}')">‚úèÔ∏è</button>
                    <button class="btn btn-danger" style="position:absolute;top:6px;right:6px;padding:2px 8px;font-size:0.95em;z-index:2;"
                        onclick="event.stopPropagation();App.deleteCustomFood('${food.name}')">üóëÔ∏è</button>
                    <div style="font-size:1.5em;margin-bottom:2px;text-align:center;"><span class="food-emoji">${food.emoji}</span></div>
                    <div style="font-weight:500;margin-bottom:2px;text-align:center;font-size:0.95em;max-width:100%;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;white-space:normal;text-overflow:ellipsis;min-height:2.6em;line-height:1.3em;">
                        ${food.name}
                    </div>
                    <div style="display:flex;justify-content:center;align-items:flex-end;gap:4px;width:100%;margin-top:auto;padding-top:4px;">
                        <div style="display:flex;flex-direction:column;align-items:center;min-width:24px;">
                            <span style="font-size:1.05em;">üî•</span>
                            <span style="font-size:0.90em;color:#e17055;">${food.calories}</span>
                        </div>
                        <div style="display:flex;flex-direction:column;align-items:center;min-width:24px;">
                            <span style="font-size:1.05em;">üí™</span>
                            <span style="font-size:0.90em;color:#0984e3;">${food.protein}</span>
                        </div>
                        <div style="display:flex;flex-direction:column;align-items:center;min-width:24px;">
                            <span style="font-size:1.05em;">üçû</span>
                            <span style="font-size:0.90em;color:#fdcb6e;">${food.carbs}</span>
                        </div>
                        <div style="display:flex;flex-direction:column;align-items:center;min-width:24px;">
                            <span style="font-size:1.05em;">ü•ë</span>
                            <span style="font-size:0.90em;color:#00b894;">${food.fats}</span>
                        </div>
                    </div>
                </div>
                `;
                    }).join('')}
            </div>
        </div>
        
        <div class="modal-column selected-column">
            <div style="padding: 20px; padding-bottom: 10px;">
                <h3>üõí Seleccionados (${state.selectedFoodsInModal.length})</h3>
                ${createSelectedTotalsHTML(selectedTotals)}
            </div>
            <div id="modal-selected-list">
                ${createSelectedFoodsListHTML()}
            </div>
            <div class="add-button-container">
                ${createAddButtonHTML()}
            </div>
        </div>
    `;
                };

                const closeFoodModal = () => {
                    document.getElementById('foodModal').style.display = 'none';
                };

                const updateModalHeights = () => {
                    const modalList = document.getElementById('modal-selected-list');
                    if (modalList) {
                        const viewportHeight = window.innerHeight;
                        modalList.style.maxHeight = `${viewportHeight * 0.6}px`;
                    }
                };

                // ===== FOOD SELECTION HANDLERS =====

                const toggleFoodSelection = (foodName, event) => {
                    const card = event?.currentTarget?.closest('.food-item-modal');
                    const isDeleteButton = event?.target?.closest('.delete-btn');
                    if (card && !isDeleteButton) {
                        // Animaciones
                        const emoji = card.querySelector('.food-emoji');
                        if (emoji) {
                            emoji.style.animation = 'none';
                            void emoji.offsetWidth;
                            emoji.style.animation = 'spinEmoji 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards';
                        }
                        card.classList.remove('clicked-animation');
                        void card.offsetWidth;
                        card.classList.add('clicked-animation');
                        renderSelectedColumn();
                    }

                    const existingIndex = state.selectedFoodsInModal.findIndex(f => f.name === foodName);

                    if (existingIndex > -1) {
                        state.selectedFoodsInModal.splice(existingIndex, 1);
                    } else {
                        state.selectedFoodsInModal.forEach(item => item.isNew = false);
                        state.selectedFoodsInModal.push({
                            name: foodName,
                            quantity: 100,
                            ...getAllFoods()[foodName],
                            isNew: true
                        });
                    }

                    // Refresca ambas columnas SIEMPRE
                    const modal = document.getElementById('foodModal');
                    const content = document.getElementById('modalContent');
                    if (modal && content) {
                        const searchInput = document.getElementById('food-search-input');
                        const searchValue = searchInput ? searchInput.value.trim() : '';
                        if (searchValue) {
                            handleFoodSearch(searchValue);
                        } else if (state.currentCategoryInModal) {
                            showFoods(state.currentCategoryInModal);
                        } else {
                            content.innerHTML = createCategorySelectionHTML();
                        }
                    }
                };

                const updateModalQuantity = (foodName, value) => {
                    const quantity = Math.max(0, parseInt(value) || 0);
                    const foodItem = state.selectedFoodsInModal.find(f => f.name === foodName);

                    if (foodItem) {
                        foodItem.quantity = quantity;
                        // Solo refresca la columna de seleccionados, no navegues
                        const selectedColumn = document.querySelector('.modal-column.selected-column');
                        if (selectedColumn) {
                            const selectedTotals = calculateTotals(state.selectedFoodsInModal);
                            const selectedList = selectedColumn.querySelector('#modal-selected-list');
                            if (selectedList) {
                                const prevScroll = selectedList.scrollTop;
                                selectedList.innerHTML = createSelectedFoodsListHTML();
                                selectedList.scrollTop = prevScroll;
                            }
                            const addBtnContainer = selectedColumn.querySelector('.add-button-container');
                            if (addBtnContainer) addBtnContainer.innerHTML = createAddButtonHTML();
                            const totalsDiv = selectedColumn.querySelector('.selected-totals');
                            if (totalsDiv) totalsDiv.outerHTML = createSelectedTotalsHTML(selectedTotals);
                        }
                    }
                    renderSelectedColumn();
                };

                const addSelectedFoods = () => {
                    const prevItems = new Set(state.selectedFoods[state.currentMeal].map(f => f.name));
                    const newItems = [];

                    state.selectedFoodsInModal.forEach(modalFood => {
                        const existingIndex = state.selectedFoods[state.currentMeal]
                            .findIndex(f => f.name === modalFood.name);

                        if (!prevItems.has(modalFood.name)) {
                            newItems.push(modalFood.name);
                        }

                        if (existingIndex > -1) {
                            state.selectedFoods[state.currentMeal][existingIndex].quantity += modalFood.quantity;
                        } else {
                            state.selectedFoods[state.currentMeal].push({
                                name: modalFood.name,
                                quantity: modalFood.quantity,
                                ...getAllFoods()[modalFood.name]
                            });
                        }
                    });

                    state.lastAddedItems = newItems;
                    state.selectedFoodsInModal = [];

                    closeFoodModal();

                    // ACTUALIZA LA DIETA ACTUAL EN savedDiets
                    if (state.currentDietId) {
                        state.savedDiets[state.currentDietId] = JSON.parse(JSON.stringify(state.selectedFoods));
                    }
                    saveState();
                    renderMeals();
                    updateTotals();
                    generateShoppingList();

                    setTimeout(() => {
                        state.lastAddedItems = [];
                        renderMeals();
                    }, 500);

                    setTimeout(() => {
                        state.selectedFoodsInModal.forEach(item => item.isNew = false);
                    }, 50);
                };

                const updateQuantity = (meal, food, value) => {
                    const quantity = Math.max(0, Number(value) || 0);
                    const item = state.selectedFoods[meal].find(i => i.name === food);

                    if (item) {
                        item.quantity = quantity;
                        // ACTUALIZA LA DIETA ACTUAL EN savedDiets
                        if (state.currentDietId) {
                            state.savedDiets[state.currentDietId] = JSON.parse(JSON.stringify(state.selectedFoods));
                        }
                        saveState();
                        renderMealContent(meal);
                        updateTotals();
                        generateShoppingList();
                    }
                };

                const removeFood = (meal, food) => {
                    state.selectedFoods[meal] = state.selectedFoods[meal].filter(f => f.name !== food);
                    // ACTUALIZA LA DIETA ACTUAL EN savedDiets
                    if (state.currentDietId) {
                        state.savedDiets[state.currentDietId] = JSON.parse(JSON.stringify(state.selectedFoods));
                    }
                    saveState();
                    renderMealContent(meal);
                    updateTotals();
                    generateShoppingList();
                };

                // ===== SHOPPING LIST =====
                const setupEventListeners = () => {
                    // Agregar cualquier evento global necesario aqu√≠
                    console.log('Event listeners configurados');
                };
                const generateShoppingList = () => {
                    const allFoods = Object.values(state.selectedFoods).flat();
                    const foodQuantities = {};

                    allFoods.forEach(food => {
                        if (!foodQuantities[food.name]) foodQuantities[food.name] = 0;
                        const multiplier = state.currentShoppingList === 'weekly' ? 7 : 30;
                        foodQuantities[food.name] += food.quantity * multiplier;
                    });

                    const sortedFoods = Object.keys(foodQuantities).sort();
                    const listContent = document.getElementById('shopping-list-content');

                    if (sortedFoods.length === 0) {
                        listContent.innerHTML = '<div style="color: #999; text-align: center; padding: 10px;">No hay productos en la lista</div>';
                        return;
                    }

                    listContent.innerHTML = sortedFoods.map(food => `
            <div class="shopping-list-item">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        ${getAllFoods()[food]?.emoji || '‚ùì'} ${food}
                    </div>
                    <div style="font-weight: bold;">${foodQuantities[food].toFixed(0)}g</div>
                </div>
            </div>
        `).join('');
                };

                const showShoppingList = (type, event) => {
                    state.currentShoppingList = type;
                    generateShoppingList();
                    updateTotals();
                    updateTabsVisualState();
                    saveState();

                    updatePeriodLabel();

                    // Update active tabs
                    document.querySelectorAll('.shopping-list-tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    event.currentTarget.classList.add('active');
                };




                // ===== DIET MANAGEMENT =====
                const deleteMeal = (meal) => {
                    if (confirm(`¬øEst√°s seguro de eliminar la comida "${meal}"?`)) {
                        delete state.selectedFoods[meal];
                        saveState();
                        renderMeals();
                        updateTotals();
                        generateShoppingList();
                    }
                };
                const createNewDiet = () => {
                    const dietNames = Object.keys(state.savedDiets);
                    if (state.currentDietIndex !== undefined && dietNames[state.currentDietIndex]) {
                        const currentDietName = dietNames[state.currentDietIndex];
                        state.savedDiets[currentDietName] = JSON.parse(JSON.stringify(state.selectedFoods));
                    }

                    let baseName = 'Nueva Dieta';
                    let counter = 1;
                    while (state.savedDiets[`${baseName} ${counter}`]) {
                        counter++;
                    }
                    const newName = `${baseName} ${counter}`;
                    state.savedDiets[newName] = JSON.parse(JSON.stringify({
                        Desayuno: [],
                        Almuerzo: [],
                        Cena: [],
                        Snacks: []
                    }));

                    const newIndex = Object.keys(state.savedDiets).indexOf(newName);
                    loadDietByIndex(newIndex, true); // <--- NO guardar el estado actual
                    saveState();
                    renderSavedDiets();
                };

                const loadDiet = (name) => {
                    // Guarda la dieta actual antes de cambiar
                    if (state.currentDietId && state.savedDiets[state.currentDietId]) {
                        state.savedDiets[state.currentDietId] = JSON.parse(JSON.stringify(state.selectedFoods));
                    }
                    if (state.savedDiets[name]) {
                        state.selectedFoods = JSON.parse(JSON.stringify(state.savedDiets[name]));
                        state.currentDietId = name;
                        saveState();
                        renderMeals();
                        updateTotals();
                        generateShoppingList();
                        document.getElementById('current-diet-title').textContent = name;
                    }
                };

                const loadDietByIndex = (index, skipSaveCurrent = false) => {
                    const dietNames = Object.keys(state.savedDiets);
                    if (dietNames.length === 0) return;

                    // Guarda la dieta actual antes de cambiar, salvo que se indique lo contrario
                    if (!skipSaveCurrent && state.currentDietId && state.savedDiets[state.currentDietId]) {
                        state.savedDiets[state.currentDietId] = JSON.parse(JSON.stringify(state.selectedFoods));
                    }

                    state.currentDietIndex = index;
                    const dietName = dietNames[state.currentDietIndex];
                    state.selectedFoods = JSON.parse(JSON.stringify(state.savedDiets[dietName]));
                    state.currentDietId = dietName;
                    saveState();
                    renderMeals();
                    updateTotals();
                    generateShoppingList();
                    document.getElementById('current-diet-title').textContent = dietName;
                };

                const deleteCurrentDiet = () => {
                    const dietNames = Object.keys(state.savedDiets);
                    if (dietNames.length <= 1) {
                        alert("No puedes eliminar la √∫ltima dieta.");
                        return;
                    }
                    if (dietNames.length === 0) return;

                    const dietName = dietNames[state.currentDietIndex];
                    if (!confirm(`¬øEst√°s seguro de que quieres eliminar la dieta "${dietName}"?`)) {
                        return;
                    }

                    delete state.savedDiets[dietName];
                    const newIndex = Math.max(0, state.currentDietIndex - 1);
                    loadDietByIndex(newIndex);
                    saveState();
                    renderSavedDiets();
                };

                const prevDiet = () => {
                    const dietNames = Object.keys(state.savedDiets);
                    if (dietNames.length === 0) return;

                    const newIndex = (state.currentDietIndex - 1 + dietNames.length) % dietNames.length;
                    loadDietByIndex(newIndex);
                };

                const nextDiet = () => {
                    const dietNames = Object.keys(state.savedDiets);
                    if (dietNames.length === 0) return;

                    const newIndex = (state.currentDietIndex + 1) % dietNames.length;
                    loadDietByIndex(newIndex);
                };

                const editDietName = () => {
                    const dietNames = Object.keys(state.savedDiets);
                    if (dietNames.length === 0) return;

                    // Guarda la dieta actual antes de renombrar
                    if (state.currentDietIndex !== undefined && dietNames[state.currentDietIndex]) {
                        const currentDietName = dietNames[state.currentDietIndex];
                        state.savedDiets[currentDietName] = JSON.parse(JSON.stringify(state.selectedFoods));
                    }

                    const oldName = dietNames[state.currentDietIndex];
                    const titleElement = document.getElementById('current-diet-title');

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = oldName;
                    input.style = `
            font-size: inherit;
            font-family: inherit;
            color: inherit;
            background: var(--surface);
            border: 2px solid var(--secondary);
            border-radius: 5px;
            padding: 5px;
            width: 200px;
        `;

                    titleElement.innerHTML = '';
                    titleElement.appendChild(input);
                    input.focus();

                    const finishEditing = () => {
                        const newName = input.value.trim();
                        if (!newName || newName === oldName) {
                            titleElement.textContent = oldName;
                            return;
                        }

                        if (state.savedDiets[newName]) {
                            alert('¬°Ya existe una dieta con ese nombre!');
                            titleElement.textContent = oldName;
                            return;
                        }

                        state.savedDiets[newName] = state.savedDiets[oldName];
                        delete state.savedDiets[oldName];
                        state.currentDietIndex = Object.keys(state.savedDiets).indexOf(newName);

                        titleElement.textContent = newName;
                        saveState();
                        renderSavedDiets();
                    };

                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') finishEditing();
                    });

                    input.addEventListener('blur', finishEditing);
                };

                // ===== MACRO CALCULATIONS =====

                const calculateMacros = () => {
                    // NO LLAMES a saveUserData() aqu√≠

                    const age = parseInt(state.userData.age);
                    const weight = parseFloat(state.userData.weight);
                    const height = parseFloat(state.userData.height);
                    const gender = state.userData.gender;
                    const activity = state.userData.activity;
                    const goal = state.userData.goal;

                    if (!age || !weight || !height) {
                        // Ocultar objetivos si falta alg√∫n dato
                        const results = document.getElementById('macro-results');
                        if (results) results.style.display = 'none';
                        state.userMacros = null;
                        state.showMacroResults = false;
                        updateTotals();
                        return;
                    }

                    // Paso 1: Calcular TMB (Ecuaci√≥n de Mifflin-St Jeor)
                    let bmr;
                    if (gender === 'male') {
                        bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
                    } else {
                        bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
                    }

                    // Paso 2: Ajustar TMB seg√∫n el nivel de actividad y el objetivo
                    const activityFactors = {
                        Sedentario: 1.2,
                        Baja: 1.375,
                        Media: 1.55,
                        Alta: 1.725,
                        Extra: 1.9
                    };

                    const adjustment = {
                        "P√©rdida de peso": -275,
                        Mantenimiento: 0,
                        "Ganancia muscular": 275
                    };

                    let tdee;
                    if (activityFactors[activity] !== undefined && adjustment[goal] !== undefined) {
                        tdee = bmr * activityFactors[activity] + adjustment[goal];
                    } else {
                        alert('Nivel de actividad o objetivo no v√°lido');
                        return;
                    }

                    // Paso 3: Calcular macronutrientes seg√∫n el objetivo
                    let protein, fats, carbs;

                    if (goal === "P√©rdida de peso") {
                        protein = weight * 2.0; // Prote√≠nas en gramos

                        fats = (tdee * 0.25) / 9; // Grasas en gramos
                        carbs = (tdee - (protein * 4) - (fats * 9)) / 4; // Carbohidratos en gramos
                    } else if (goal === "Mantenimiento") {
                        protein = weight * 1.6; // Prote√≠nas en gramos
                        fats = (tdee * 0.30) / 9; // Grasas en gramos
                        carbs = (tdee - (protein * 4) - (fats * 9)) / 4; // Carbohidratos en gramos
                    } else if (goal === "Ganancia muscular") {
                        protein = weight * 1.8; // Prote√≠nas en gramos
                        fats = (tdee * 0.20) / 9; // Grasas en gramos
                        carbs = (tdee - (protein * 4) - (fats * 9)) / 4; // Carbohidratos en gramos
                    }

                    // Guardar los resultados en el estado
                    state.userMacros = {
                        calories: Math.round(tdee),
                        protein: parseFloat(protein.toFixed(2)),
                        carbs: parseFloat(carbs.toFixed(2)),
                        fats: parseFloat(fats.toFixed(2))
                    };

                    showMacroResults();
                    updateTotals();
                };

                const showMacroResults = () => {
                    const results = document.getElementById('macro-results');
                    results.style.display = 'block';

                    // Update target values display
                    document.getElementById('target-calories').textContent = state.userMacros.calories;
                    document.getElementById('target-protein').textContent = state.userMacros.protein;
                    document.getElementById('target-carbs').textContent = state.userMacros.carbs;
                    document.getElementById('target-fats').textContent = state.userMacros.fats;

                    state.showMacroResults = true;
                    saveState(); // A√±adir esta l√≠nea para guardar el estado
                    updateTotals();
                };

                const updateTotals = () => {
                    const totals = calculateTotals(Object.values(state.selectedFoods).flat());


                    // Apply multiplier to daily cost
                    const multiplier = state.currentShoppingList === 'weekly' ? 7 : 30;
                    const totalCost = totals.cost * multiplier;
                    document.getElementById('total-cost').textContent = totalCost.toFixed(2);

                    if (state.userMacros) {
                        document.getElementById('current-calories').textContent = totals.calories.toFixed(1);
                        document.getElementById('current-protein').textContent = totals.protein.toFixed(1);
                        document.getElementById('current-carbs').textContent = totals.carbs.toFixed(1);
                        document.getElementById('current-fats').textContent = totals.fats.toFixed(1);

                        updateProgress(totals.calories, state.userMacros.calories, 'calories-progress');
                        updateProgress(totals.protein, state.userMacros.protein, 'protein-progress');
                        updateProgress(totals.carbs, state.userMacros.carbs, 'carbs-progress');
                        updateProgress(totals.fats, state.userMacros.fats, 'fats-progress');
                    }
                };

                const updateProgress = (current, target, elementId) => {
                    const progressFill = document.getElementById(elementId);
                    const progressExcess = progressFill.parentElement.querySelector('.progress-excess');

                    const percentage = (current / target) * 100;
                    const fillWidth = Math.min(percentage, 100);
                    const excessWidth = Math.max(percentage - 100, 0);

                    progressFill.style.width = `${fillWidth}%`;
                    progressExcess.style.width = `${excessWidth}%`;

                    progressFill.style.borderRadius = fillWidth >= 100 ? '8px' : '8px 0 0 8px';
                    progressExcess.style.borderRadius = excessWidth > 0 ? '0 8px 8px 0' : '0';

                    progressExcess.style.clipPath = excessWidth > 0
                        ? `inset(0 ${100 - excessWidth}% 0 0)`
                        : 'inset(0 0 0 100%)';
                };

                // ===== PDF EXPORT =====

                const exportPDF = () => {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF();

                    // T√≠tulo principal
                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(18);
                    pdf.text('Plan Diet√©tico', 105, 15, { align: 'center' });

                    let y = 25;

                    // ====== TOTALES DIARIOS ======
                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(14);
                    pdf.setTextColor(0, 0, 0);
                    const title = 'Totales diarios';
                    pdf.text(title, 15, y);
                    const titleWidth = pdf.getTextWidth(title);
                    pdf.setDrawColor(0, 0, 0);
                    pdf.setLineWidth(0.5);
                    pdf.line(15, y + 1.5, 15 + titleWidth, y + 1.5);
                    y += 9;

                    // Macros en una l√≠nea
                    const totals = calculateTotals(Object.values(state.selectedFoods).flat());
                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(11);
                    pdf.setTextColor(80, 80, 80);
                    pdf.text(
                        `Calor√≠as: ${totals.calories.toFixed(1)} kcal | Prote√≠nas: ${totals.protein.toFixed(1)}g | Carbohidratos: ${totals.carbs.toFixed(1)}g | Grasas: ${totals.fats.toFixed(1)}g | Coste${totals.cost.toFixed(2)}‚Ç¨`,
                        20, y
                    );
                    y += 12;

                    // L√≠nea divisoria al final de la secci√≥n
                    pdf.setDrawColor(180);
                    pdf.line(15, y, 195, y);
                    y += 7;

                    // ====== DIETA DETALLADA ======
                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(14);
                    pdf.setTextColor(0, 0, 0);
                    const titleDiet = 'Dieta';
                    pdf.text(titleDiet, 15, y);
                    const titleDietWidth = pdf.getTextWidth(titleDiet);
                    pdf.setDrawColor(0, 0, 0);
                    pdf.setLineWidth(0.5);
                    pdf.line(15, y + 1.5, 15 + titleDietWidth, y + 1.5);
                    y += 9;

                    Object.entries(state.selectedFoods).forEach(([meal, foods]) => {
                        if (foods.length === 0) return;
                        pdf.setFont('helvetica', 'bold');
                        pdf.setFontSize(12);
                        pdf.setTextColor(40, 40, 40);
                        pdf.text(`‚Ä¢ ${meal}`, 18, y);
                        y += 6;

                        pdf.setFont('helvetica', 'normal');
                        pdf.setFontSize(11);
                        pdf.setTextColor(80, 80, 80);
                        foods.forEach(food => {
                            pdf.text(`${food.name} (${food.quantity}g)`, 25, y);
                            pdf.text(
                                `Cal: ${(food.calories * food.quantity / 100).toFixed(1)} | P: ${(food.protein * food.quantity / 100).toFixed(1)}g | C: ${(food.carbs * food.quantity / 100).toFixed(1)}g | G: ${(food.fats * food.quantity / 100).toFixed(1)}g`,
                                80, y
                            );
                            y += 6;
                            if (y > 270) { pdf.addPage(); y = 15; }
                        });
                        y += 3;
                    });

                    // L√≠nea divisoria al final de la secci√≥n
                    pdf.setDrawColor(180);
                    pdf.line(15, y, 195, y);
                    y += 7;

                    // ====== LISTA DE LA COMPRA ======
                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(14);
                    pdf.setTextColor(0, 0, 0);
                    const titleShopping = 'Lista de la compra';
                    pdf.text(titleShopping, 15, y);
                    const titleShoppingWidth = pdf.getTextWidth(titleShopping);
                    pdf.setDrawColor(0, 0, 0);
                    pdf.setLineWidth(0.5);
                    pdf.line(15, y + 1.5, 15 + titleShoppingWidth, y + 1.5);
                    y += 9;

                    // Calcula la lista de la compra igual que en la app
                    const multiplier = state.currentShoppingList === 'weekly' ? 7 : 30;
                    const allFoods = Object.values(state.selectedFoods).flat();
                    allFoods.forEach(food => {
                        if (!foodQuantities[food.name]) foodQuantities[food.name] = 0;
                        foodQuantities[food.name] += food.quantity * multiplier;
                    });
                    const sortedFoods = Object.keys(foodQuantities).sort();

                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(11);
                    pdf.setTextColor(80, 80, 80);
                    sortedFoods.forEach(food => {
                        pdf.text(
                            `${food}: ${foodQuantities[food].toFixed(0)}g`,
                            20, y
                        );
                        y += 6;
                        if (y > 270) { pdf.addPage(); y = 15; }
                    });

                    // L√≠nea divisoria al final de la secci√≥n
                    pdf.setDrawColor(180);
                    pdf.line(15, y, 195, y);

                    pdf.save('dieta.pdf');
                };

                // ===== HELPER FUNCTIONS =====



                const getCategoryColor = (category) => {
                    const colors = {
                        'Prote√≠nas': 'rgba(246, 229, 141, 0.3)',
                        'L√°cteos': 'rgba(126, 214, 223, 0.3)',
                        'Cereales': 'rgba(186, 220, 88, 0.3)',
                        'Tub√©rculos': 'rgba(222, 184, 135, 0.3)',
                        'Verduras': 'rgba(106, 176, 76, 0.3)',
                        'Frutas': 'rgba(255, 121, 121, 0.3)',
                        'Legumbres': 'rgba(210, 180, 140, 0.3)',
                        'Grasas': 'rgba(255, 190, 118, 0.3)',
                        'Bebidas': 'rgba(100, 149, 237, 0.3)',
                        'Especias': 'rgba(139, 69, 19, 0.3)',
                        'Endulzantes': 'rgba(255, 215, 0, 0.3)',
                        'Platos preparados': 'rgba(255, 165, 0, 0.3)'
                    };
                    return colors[category] || 'rgba(248, 249, 250, 0.3)';
                };

                const addMeal = () => {
                    const newMealName = prompt('Nombre de la nueva comida:');
                    if (newMealName && newMealName.trim()) {
                        const mealName = newMealName.trim();
                        if (state.selectedFoods[mealName]) {
                            alert('Ya existe una comida con ese nombre.');
                            return;
                        }
                        state.selectedFoods[mealName] = [];
                        // ACTUALIZA LA DIETA ACTUAL EN savedDiets
                        if (state.currentDietId) {
                            state.savedDiets[state.currentDietId] = JSON.parse(JSON.stringify(state.selectedFoods));
                        }
                        saveState();
                        renderMeals();
                    }
                };

                const calculateTotals = (foods) => {
                    return foods.reduce((acc, food) => ({
                        calories: acc.calories + (food.calories * food.quantity / 100),
                        protein: acc.protein + (food.protein * food.quantity / 100),
                        carbs: acc.carbs + (food.carbs * food.quantity / 100),
                        fats: acc.fats + (food.fats * food.quantity / 100),
                        cost: acc.cost + (food.price * food.quantity / 100)
                    }), { calories: 0, protein: 0, carbs: 0, fats: 0, cost: 0 });
                };

                // ===== PUBLIC API =====
                return {
                    init,
                    toggleTheme: () => {
                        const newTheme = state.theme === 'light' ? 'dark' : 'light';
                        setTheme(newTheme);
                    },
                    showFoodModal,
                    goToCategories: () => {
                        state.currentCategoryInModal = null;
                        App.showFoodModal();
                    },
                    closeFoodModal,
                    showFoods,
                    toggleFoodSelection,
                    addSelectedFoods,
                    updateQuantity,
                    removeFood,
                    deleteMeal,
                    loadDiet,
                    loadDietByIndex,
                    deleteCurrentDiet,
                    prevDiet,
                    nextDiet,
                    showShoppingList,
                    exportPDF,
                    updateModalQuantity,
                    createNewDiet,
                    editDietName,
                    calculateMacros,
                    handleFoodSearch,
                    addMeal,
                    openRecipesModal,
                    closeRecipesModal,
                    renderRecipesList,
                    openRecipeDetail,
                    closeRecipeDetail,
                    addRecipeToMeal,
                    openRecipeEditor,
                    closeRecipeEditor,
                    addIngredientToRecipe,
                    removeIngredientFromRecipe,
                    saveRecipe,
                    deleteRecipe,
                    updateUserIntolerancias: setupUserIntoleranciasBtns,
                    openFoodEditor: (foodName = null) => {
                        editingFoodName = foodName;
                        document.getElementById('food-editor-title').textContent = foodName ? 'Editar alimento' : 'Nuevo alimento';
                        // Busca primero en customFoods, luego en foodDB
                        const f = foodName ? (customFoods[foodName] || foodDB[foodName]) : {};
                        document.getElementById('food-editor-name').value = foodName || '';
                        document.getElementById('food-editor-emoji').value = f?.emoji || 'üçΩÔ∏è';
                        document.getElementById('food-editor-emoji-btn').textContent = f?.emoji || 'üçΩÔ∏è';
                        document.getElementById('food-editor-category').value = f?.category || '';
                        document.getElementById('food-editor-calories').value = f?.calories || '';
                        document.getElementById('food-editor-protein').value = f?.protein || '';
                        document.getElementById('food-editor-carbs').value = f?.carbs || '';
                        document.getElementById('food-editor-fats').value = f?.fats || '';
                        document.getElementById('food-editor-price').value = f?.price || '';

                        // Cargar intolerancias si el alimento existe
                        const intolerancias = f?.intolerancias || [];
                        document.querySelectorAll('#food-editor-Intolerancias input[type="checkbox"]').forEach(cb => {
                            cb.checked = intolerancias.includes(cb.value);
                        });

                        document.getElementById('foodEditorModal').style.display = 'flex';
                    },
                    closeFoodEditor: () => {
                        document.getElementById('foodEditorModal').style.display = 'none';
                    },
                    saveFoodEditor: () => {
                        const name = document.getElementById('food-editor-name').value.trim();
                        if (!name) return alert('Pon un nombre');
                        // Recoge las intolerancias seleccionadas
                        const intolerancias = Array.from(document.querySelectorAll('#food-editor-Intolerancias input[type="checkbox"]:checked')).map(cb => cb.value);
                        const food = {
                            emoji: document.getElementById('food-editor-emoji').value || 'üçΩÔ∏è',
                            category: document.getElementById('food-editor-category').value,
                            calories: Number(document.getElementById('food-editor-calories').value) || 0,
                            protein: Number(document.getElementById('food-editor-protein').value) || 0,
                            carbs: Number(document.getElementById('food-editor-carbs').value) || 0,
                            fats: Number(document.getElementById('food-editor-fats').value) || 0,
                            price: Number(document.getElementById('food-editor-price').value) || 0,
                            intolerancias // <--- ahora s√≠ existe la variable
                        };
                        // Si el nombre cambi√≥ y estaba en customFoods, b√≥rralo
                        if (editingFoodName && editingFoodName !== name && customFoods[editingFoodName]) {
                            delete customFoods[editingFoodName];
                        }
                        customFoods[name] = food;
                        localStorage.setItem('customFoods', JSON.stringify(customFoods));
                        // Actualiza comidas con el nuevo alimento
                        App.updateFoodInMeals(editingFoodName, name, food);
                        App.closeFoodEditor();
                        if (state.currentCategoryInModal) {
                            App.showFoods(state.currentCategoryInModal);
                        }
                    },
                    deleteCustomFood: (foodName) => {
                        if (confirm('¬øEliminar este alimento?')) {
                            // Si existe en customFoods, b√≥rralo
                            if (customFoods[foodName]) {
                                delete customFoods[foodName];
                                localStorage.setItem('customFoods', JSON.stringify(customFoods));
                            } else {
                                // Si es de base, crea una marca en localStorage para ocultarlo
                                let deletedFoods = JSON.parse(localStorage.getItem('deletedFoods') || '[]');
                                if (!deletedFoods.includes(foodName)) {
                                    deletedFoods.push(foodName);
                                    localStorage.setItem('deletedFoods', JSON.stringify(deletedFoods));
                                }
                            }
                            App.showFoodModal();
                        }
                    },
                    openEmojiPicker: () => {
                        const picker = document.getElementById('emoji-picker');
                        const btn = document.getElementById('food-editor-emoji-btn');
                        // Si ya est√° visible, ocultar
                        if (picker.style.display === 'block') {
                            picker.style.display = 'none';
                            return;
                        }
                        // Rellenar solo una vez
                        if (!picker.innerHTML.trim()) {
                            const emojis = [
                                'üçó', 'ü•ö', 'üêü', 'ü¶É', 'üçñ', 'üßÄ', 'ü•õ', 'üåæ', 'üçö', 'üçû', 'ü•¶', 'ü•¨', 'üçÖ', 'ü•ï', 'üç†', 'üçé', 'üçå', 'ü•ù', 'üçì', 'ü•£', 'ü•ë', 'ü´í', 'üå∞', 'üå±', 'üíß', 'üåø', 'üçØ', 'üç≤', 'üçΩÔ∏è',
                                'üçÜ', 'üç§', 'üçî', 'üçü', 'üçï', 'ü•ó', 'üç≥', 'ü•û', 'üçò', 'üç©', 'üçõ', 'üçú', 'üçù', 'ü•™', 'ü•ô', 'ü•í', 'ü•î', 'üçá', 'üçâ', 'üçä', 'üçã', 'üçç', 'ü•≠', 'üçë', 'üçí', 'ü••', 'ü•ú', 'ü•Ø', 'ü•®'
                            ];
                            picker.innerHTML = `<div style="display:grid;grid-template-columns:repeat(8,1fr);gap:4px;">${emojis.map(e =>
                                `<button style="font-size:1.3em;padding:6px 2px;border:none;background:none;cursor:pointer;border-radius:6px;" onclick="App.selectEmoji('${e}')" tabindex="0">${e}</button>`
                            ).join('')
                                }</div>`;
                        }
                        picker.style.display = 'block';
                        picker.style.minWidth = '320px';
                        picker.style.maxWidth = '420px';
                        setTimeout(() => {
                            document.addEventListener('mousedown', closeEmojiPickerOnClickOutside);
                        }, 0);
                        function closeEmojiPickerOnClickOutside(e) {
                            if (!picker.contains(e.target) && e.target !== btn) {
                                picker.style.display = 'none';
                                document.removeEventListener('mousedown', closeEmojiPickerOnClickOutside);
                            }
                        }
                    },
                    selectEmoji: (emoji) => {
                        document.getElementById('food-editor-emoji').value = emoji;
                        document.getElementById('food-editor-emoji-btn').textContent = emoji;
                        document.getElementById('emoji-picker').style.display = 'none';
                    },
                    updateFoodInMeals: (oldName, newName, newData) => {
                        Object.keys(state.selectedFoods).forEach(meal => {
                            state.selectedFoods[meal] = state.selectedFoods[meal].map(f => {
                                if (f.name === oldName) {
                                    return {
                                        ...f,
                                        name: newName,
                                        emoji: newData.emoji,
                                        category: newData.category,
                                        calories: newData.calories,
                                        protein: newData.protein,
                                        carbs: newData.carbs,
                                        fats: newData.fats,
                                        price: newData.price
                                    };
                                }
                                return f;
                            });
                        });
                        // Guarda cambios en la dieta actual
                        if (state.currentDietId) {
                            state.savedDiets[state.currentDietId] = JSON.parse(JSON.stringify(state.selectedFoods));
                        }
                        saveState();
                        renderMeals();
                        updateTotals();
                        generateShoppingList();
                    },
                };
            })();
            function syncUserIntoleranciasBtns() {
                // Obtiene el array actual de intolerancias del usuario
                const intolerancias = (window.state?.userIntolerancias) || JSON.parse(localStorage.getItem('userIntolerancias') || '[]');
                // Marca/desmarca todos los botones en todos los paneles
                document.querySelectorAll('.intolerancia-btn[data-value]').forEach(btn => {
                    if (intolerancias.includes(btn.dataset.value)) {
                        btn.classList.add('selected', 'active');
                    } else {
                        btn.classList.remove('selected', 'active');
                    }
                });
            }

            function setupUserIntoleranciasBtns() {
                document.querySelectorAll('.intolerancia-btn[data-value]').forEach(btn => {
                    btn.onclick = () => {
                        // Alterna el estado en el array global
                        let intolerancias = (window.state?.userIntolerancias) || JSON.parse(localStorage.getItem('userIntolerancias') || '[]');
                        const value = btn.dataset.value;
                        if (intolerancias.includes(value)) {
                            intolerancias = intolerancias.filter(i => i !== value);
                        } else {
                            intolerancias.push(value);
                        }
                        // Actualiza el estado global y localStorage
                        if (window.state) state.userIntolerancias = intolerancias;
                        localStorage.setItem('userIntolerancias', JSON.stringify(intolerancias));
                        // Sincroniza todos los botones en todos los paneles
                        syncUserIntoleranciasBtns();

                        // --- NUEVO: recarga el modal completo si est√° abierto ---
                        const modal = document.getElementById('foodModal');
                        if (modal && modal.style.display === 'flex') {
                            if (state.currentCategoryInModal) {
                                App.showFoods(state.currentCategoryInModal);
                            } else {
                                App.showFoodModal();
                            }
                        }
                    };
                });
                // Sincroniza visualmente al iniciar
                syncUserIntoleranciasBtns();
            }

            // Initialize the app when DOM is loaded
            document.addEventListener('DOMContentLoaded', () => {
                App.init();

                // Sincronizar scroll entre columnas
                const leftCol = document.querySelector('.container > div:not(.totals-section):not(aside)');
                const rightCol = document.querySelector('.totals-section');

                const syncScroll = (delta, targetCol) => {
                    targetCol.scrollTop += delta;
                };

                leftCol.addEventListener('wheel', e => {
                    const delta = e.deltaY;
                    if (delta > 0 && leftCol.scrollTop + leftCol.clientHeight >= leftCol.scrollHeight - 1) {
                        syncScroll(delta, rightCol);
                        e.preventDefault();
                    } else if (delta < 0 && leftCol.scrollTop <= 0 && rightCol.scrollTop > 0) {
                        syncScroll(delta, rightCol);
                        e.preventDefault();
                    }
                }, { passive: false });

                rightCol.addEventListener('wheel', e => {
                    const delta = e.deltaY;
                    // Scroll hacia abajo al final de la derecha ‚Üí mueve la izquierda
                    if (delta > 0 && rightCol.scrollTop + rightCol.clientHeight >= rightCol.scrollHeight - 1) {
                        syncScroll(delta, leftCol);
                        e.preventDefault();
                    }
                    // Scroll hacia arriba al principio de la derecha ‚Üí mueve la izquierda
                    else if (delta < 0 && rightCol.scrollTop <= 0 && leftCol.scrollTop > 0) {
                        syncScroll(delta, leftCol);
                        e.preventDefault();
                    }
                }, { passive: false });

                document.getElementById('open-recipes-btn').onclick = App.openRecipesModal;

                // Cerrar modales de recetas al hacer clic fuera del contenido
                ['recipesModal', 'recipeEditorModal', 'recipeDetailModal'].forEach(id => {
                    const modal = document.getElementById(id);
                    if (modal) {
                        modal.addEventListener('mousedown', e => {
                            if (e.target === modal) {
                                if (id === 'recipesModal') App.closeRecipesModal();
                                if (id === 'recipeEditorModal') App.closeRecipeEditor();
                                if (id === 'recipeDetailModal') App.closeRecipeDetail();
                            }
                        });
                    }
                });

                document.addEventListener('mousedown', function (e) {
                    const modal = document.getElementById('foodEditorModal');
                    if (!modal || modal.style.display === 'none') return;
                    if (e.target === modal) {
                        App.closeFoodEditor();
                    }
                });
            });


        </script>

        <!-- Modal para crear/editar alimento personalizado -->
        <div class="modal" id="foodEditorModal" style="display:none;">
            <div class="modal-content" style="max-width:400px;flex-direction:column;">
                <h2 id="food-editor-title">Nuevo alimento</h2>
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                    <div style="position:relative;">
                        <button id="food-editor-emoji-btn" type="button"
                            style="font-size:1.5em;width:48px;height:48px;padding:0;border-radius:8px;border:1.5px solid #ccc;background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;"
                            onclick="App.openEmojiPicker()" tabindex="0">üçΩÔ∏è</button>
                        <div id="emoji-picker"
                            style="display:none;position:absolute;top:52px;left:0;z-index:3000;background:white;border:1px solid #ccc;padding:8px;border-radius:8px;max-width:320px;max-height:220px;overflow-y:auto;box-shadow:0 2px 8px rgba(0,0,0,0.15);">
                        </div>
                        <input id="food-editor-emoji" type="hidden">
                    </div>
                    <input id="food-editor-name" type="text" placeholder="Nombre" style="flex:1;margin-bottom:0;">
                </div>
                <select id="food-editor-category" style="width:100%;margin-bottom:8px;">
                    <option value="">Categor√≠a</option>
                    <option value="Prote√≠nas">Prote√≠nas</option>
                    <option value="L√°cteos">L√°cteos</option>
                    <option value="Cereales">Cereales</option>
                    <option value="Tub√©rculos">Tub√©rculos</option>
                    <option value="Verduras">Verduras</option>
                    <option value="Frutas">Frutas</option>
                    <option value="Legumbres">Legumbres</option>
                    <option value="Grasas">Grasas</option>
                    <option value="Bebidas">Bebidas</option>
                    <option value="Especias">Especias</option>
                    <option value="Endulzantes">Endulzantes</option>
                    <option value="Platos preparados">Platos preparados</option>
                    <option value="Personalizados">Personalizados</option>
                </select>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <span style="font-size:1.2em;width:28px;text-align:center;">üî•</span>
                    <input id="food-editor-calories" type="number" placeholder="Calor√≠as (100g)" style="flex:1;">
                </div>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <span style="font-size:1.2em;width:28px;text-align:center;">üí™</span>
                    <input id="food-editor-protein" type="number" placeholder="Prote√≠na (g/100g)" style="flex:1;">
                </div>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <span style="font-size:1.2em;width:28px;text-align:center;">üçû</span>
                    <input id="food-editor-carbs" type="number" placeholder="Carbohidratos (g/100g)" style="flex:1;">
                </div>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <span style="font-size:1.2em;width:28px;text-align:center;">ü•ë</span>
                    <input id="food-editor-fats" type="number" placeholder="Grasas (g/100g)" style="flex:1;">
                </div>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <span style="font-size:1.2em;width:28px;text-align:center;">üíµ</span>
                    <input id="food-editor-price" type="number" placeholder="Precio ‚Ç¨/100g" style="flex:1;">
                </div>
                <div style="margin-bottom:8px;">
                    <label style="font-size:0.98em;font-weight:500;">Intolerancias:</label>
                    <div id="food-editor-Intolerancias" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px;">
                        <label><input type="checkbox" value="gluten"> Gluten</label>
                        <label><input type="checkbox" value="lactosa"> Lactosa</label>
                        <label><input type="checkbox" value="frutos secos"> Frutos secos</label>
                        <label><input type="checkbox" value="huevo"> Huevo</label>
                        <label><input type="checkbox" value="soja"> Soja</label>
                        <label><input type="checkbox" value="marisco"> Marisco</label>
                        <label><input type="checkbox" value="pescado"> Pescado</label>
                        <!-- A√±adir m√°s si lo deseas -->
                    </div>
                </div>
                <div style="display:flex;gap:10px;justify-content:flex-end;">
                    <button class="btn" onclick="App.closeFoodEditor()">Cancelar</button>
                    <button class="btn btn-primary" onclick="App.saveFoodEditor()">Guardar</button>
                </div>
            </div>
        </div>
</body>

</html>